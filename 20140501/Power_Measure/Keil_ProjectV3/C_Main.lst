C51 COMPILER V9.00   C_MAIN                                                                04/28/2014 09:24:44 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE C_MAIN
OBJECT MODULE PLACED IN .\C_Main.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE ..\System_Function\C_Main.c BROWSE INCDIR(..\CPU_Register;..\Hard_Module;..
                    -\System_Function) DEBUG OBJECTEXTEND PRINT(.\C_Main.lst) OBJECT(.\C_Main.obj)

line level    source

   1          
   2          /*=========================================================
   3                              ¹¦ÂÊ¼Æ       ----ÓÐÏÞ¹«Ë¾
   4          °æ    ±¾£ºV1.0
   5          ¿ª·¢Ê±¼ä£º2010Äê7ÔÂ26ÈÕ
   6          °æÈ¨ËùÓÐ£º2010--2099,ºÓ±±¿Æ¼¼´óÑ§  ÐÅÏ¢¿ÆÑ§Óë¹¤³ÌÏµ  ÃÏÖ¾ÓÀ
   7                                                                        ÊÖ»ú£º13933120973
   8                                                                                     Email£ºKDMZY@163.com
   9            ÎÄ ¼þ Ãû£ºC_Main.c
  10            ×÷    Õß: ÃÏÖ¾ÓÀ
  11            °æ    ±¾: V1.0
  12            Íê³ÉÈÕÆÚ: 2010Äê7ÔÂ29ÈÕ
  13            ÃèÊöÐÅÏ¢: ¹¦ÂÊ¼Æ
  14            ÆäËûËµÃ÷: Ð¾Æ¬ÀàÐÍ£ºSTC12C5604AD  Ö÷Æµ£º11.0592MHz       
  15            ¹¦ÄÜÁÐ±í: 
  16                                  1¡¢ÏµÍ³³õÊ¼»¯
  17                                  2¡¢CS5460Ð¾Æ¬³õÊ¼»¯¼°ÅäÖÃ
  18                                  3¡¢UART0´®ÐÐ¿ÚÊÕ·¢´¦Àí
  19                                  4¡¢6Í¨µÀµÄµçÁ÷ÕæÓÐÐ§Öµ¡¢µçÑ¹ÕæÓÐÐ§Öµ
  20                                  5¡¢485ÊÕ·¢¿ØÖÆ
  21            ÀúÊ·¼ÍÂ¼:   
  22                      1¡¢ÈÕ    ÆÚ:
  23                         ×÷    Õß:
  24                         ÐÞ¸ÄÄÚÈÝ:
  25          =========================================================*/
  26          
  27          /*=============Í·ÎÄ¼þÉùÃ÷================================*/
  28          #include "STC12C5620AD_H.h"
  29          
  30          #include "H_STC12C5404ADMdu.H"
  31          #include "H_STCE2PROM.h"
  32          #include "H_Interface.h"
  33          #include "H_CS5460.h"
  34          #include "intrins.h"
  35          
  36          /*=======================================================================
  37                                          ÏµÍ³¹«¹²±äÁ¿ÉùÃ÷
  38          =======================================================================*/
  39                            bit Flag_10ms   = 0;          // 10ms±êÖ¾
  40                           // bit Flag_100ms  = 0;        // 100ms±êÖ¾
  41                           // bit Flag_1000ms = 0;        // 1000ms±êÖ¾
  42                           // bit Flag_5s     = 0;      // 5Ãë±êÖ¾
  43          
  44          //unsigned char Counter_10ms   = 0;   // 10ms¼ÆÊýÆ÷
  45          //unsigned char Counter_100ms  = 0;     // 100ms¼ÆÊýÆ÷
  46          //unsigned char Counter_1000ms = 0;     // 1000ms¼ÆÊýÆ÷
  47          
  48          
  49          #define conSysPowerOnState  0x00        
  50          #define conSysIDLEState     0x01        
  51          #define conSysCabState      0x02    
  52          
  53          unsigned char System_State   = conSysPowerOnState;
  54          unsigned  int State_Timer    = 0;
C51 COMPILER V9.00   C_MAIN                                                                04/28/2014 09:24:44 PAGE 2   

  55                            bit SystemLED_Flag;
  56          
  57          /*=======================================================================
  58          Êý¾ÝÉÏ´«¸ñÊ½ÈçÏÂ£º
  59          [@ZZ$D#YY-XX:0000.00V|0000.00A|0000.00W|0000.00Q|0000.00@|0000.00H|0000.00S|CRC]
  60          1¡¢ÒÔ'['¿ªÊ¼£¬ÒÔ']'½áÊø
  61          2¡¢@´Ó»úµØÖ·
  62          3¡¢#Í¨µÀºÅ
  63          4¡¢²ÎÊýÐòºÅ£º00£ºµçÑ¹
  64                       01£ºµçÁ÷
  65                                   02£º¹¦ÂÊ
  66                                   03£º¹¦ÂÊÒòÊý
  67                                   04£ºÏàÎ»²î½Ç
  68                                   05£ºÆµÂÊ
  69                                   06£ºÖÜÆÚ
  70                                   07£ºÔ¤Áô
  71                                   08£ºÔ¤Áô
  72                                   09£ºÔ¤Áô
  73                                   FF£º±íÊ¾ÒÔÉÏÈ«²¿²ÎÊý
  74                  Ã¿¸ö²ÎÊý²ÉÓÃ¹Ì¶¨¸ñÊ½£¬¼´0000.00µ¥Î»£¬¸÷¸ö²ÎÊýÒÔ¡®|¡¯¸ô¿ª
  75                  ¸÷¸ö²ÎÊýµÄ¾ßÌå·¶Î§ÈçÏÂ£º
  76                          µç    Ñ¹£º0¡«45.0V
  77                          µç    Á÷£º0¡«5A
  78                          ¹¦ ÂÊ Öµ£º0¡«2250W
  79          
  80          5¡¢³ý[]·ûºÅÒÔÍâµÄÆäËûÊý¾ÝµÄºÍÈ»ºó×ª»»ÎªASCIIÂë£¬·¶Î§´Ó000~256
  81          
  82          [@ZZ$R# R-XX:FFFFFF|CRC]:±íÊ¾ÉÏ´«µÄZZµ¥Æ¬»úµÄXXµØÖ·¼Ä´æÆ÷µÄÄÚÈÝ
  83          [@ZZ$S#  ACK       |CRC]£º
  84          [@ZZ$S# nACK       |CRC]£º
  85          =======================================================================*/
  86          /*=======================================================================
  87          Êý¾ÝÏÂ´«¸ñÊ½ÈçÏÂ£º
  88          0123456789ABCDEF
  89          [@ZZ$D#YY-XX       CRC]£º±íÊ¾¶ÁÈ¡ZZµØÖ·µ¥Æ¬»úµÄYYÍ¨µÀµÄµÚXXÏî²ÎÊý
  90                                                   µ±XX=FFÊ±±íÊ¾£¬Ò»´Î»ñÈ¡ÆäYYÍ¨µÀµÄËùÓÐ²ÎÊý
  91          [@ZZ$R#R-XX        CRC]£º±íÊ¾¶ÁÈ¡FµØÖ·µ¥Æ¬»úµÄXXµØÖ·¼Ä´æÆ÷µÄÄÚÈÝ
  92          
  93          [@ZZ$W#R-XX|FFFFFF CRC]£º±íÊ¾Ð´ZZµØÖ·µ¥Æ¬»úµÄXX¼Ä´æÆ÷µÄÄÚÈÝ
  94          
  95          [@ZZ$C# 0-VIDC      CRC]£º±íÊ¾Ð´ZZµØÖ·µ¥Æ¬»úµÄµçÑ¹µçÁ÷½øÐÐDCÐ£×¼
  96          [@ZZ$C# 1-VIAC      CRC]£º±íÊ¾Ð´ZZµØÖ·µ¥Æ¬»úµÄµçÑ¹µçÁ÷½øÐÐACÐ£×¼
  97          [@ZZ$C# 2-VIGain    CRC]£º±íÊ¾Ð´ZZµØÖ·µ¥Æ¬»úµÄµçÑ¹µçÁ÷½øÐÐÔöÒæÐ£×¼
  98          [@ZZ$C# 3-VIOffset  CRC]£º±íÊ¾Ð´ZZµØÖ·µ¥Æ¬»úµÄµçÑ¹µçÁ÷½øÐÐÆ«ÖÃÐ£×¼
  99          
 100          [@ZZ$S#T-Cnn       CRC]£º±íÊ¾Ð´ZZµØÖ·µ¥Æ¬»úµÄÊý¾Ý×Ô¶¯ÉÏ´«¹¦ÄÜµÄÉèÖÃ
 101                                   nn±íÊ¾Ê±¼ä¼ä¸ôµ¥Î»Ãë
 102                                                   nn=00Ê±±íÊ¾½ûÖ¹×Ô¶¯Á¬ÐøÉÏ´«¹¦ÄÜ
 103          [@ZZ$S#S-4800,8,1,0CRC]£º´®ÐÐ¿Ú²¨ÌØÂÊÉèÖÃ
 104          [@ZZ$S#A-XX        CRC]£ºÉèÖÃZZµ¥Æ¬»úµÄÍ¨Ñ¶µØÖ·ÎªXX
 105          =======================================================================*/
 106          unsigned char idata Device_Address;    // ±¾»úµØÖ·
 107          
 108          #define con_UART0TranMaxNum      38                          //  30
 109          unsigned char idata UART0_TranBuf[con_UART0TranMaxNum]; //  = { "[ 0000.00V|0000.00A|0000.00W|0000.00Q|000
             -0.00@|0000.00H|0000.00S|]" }; // ´®ÐÐ¿Ú0µÄ·¢ËÍ»º³åÇø
 110          unsigned char idata UART0_TranMaxNum;
 111          unsigned char idata UART0_TranCounter;          // ´®ÐÐ¿Ú0µÄ·¢ËÍ¼ÆÊýÆ÷
 112          
 113          #define con_UART0ReceMaxNum        7
 114          unsigned char  data UART0_ReceBuf[con_UART0ReceMaxNum];                 // ´®ÐÐ¿Ú0½ÓÊÕ»º³åÇø
 115          unsigned char idata UART0_ReceCounter;          // ´®ÐÐ¿Ú0µÄ½ÓÊÕ¼ÆÊýÆ÷
C51 COMPILER V9.00   C_MAIN                                                                04/28/2014 09:24:44 PAGE 3   

 116                            bit       UART0_ReceOKFlag = 0;       // ´®ÐÐ¿Ú0µÄ½ÓÊÕºÃ±êÖ¾
 117          unsigned char idata UART0_TranState;        // ´®ÐÐ¿ÚÉÏ´«×´Ì¬×Ö
 118          unsigned char idata UART0_TranChannel;      // ÒªÉÏ´«µÄÍ¨µÀºÅ
 119          
 120          unsigned char code con_HexCode[]  = { "0123456789ABCDEF" }; 
 121          unsigned char idata CS5460_Channel = 0;
 122          
 123          /*
 124          unsigned char xdata Measure_Buf[8][3][8] = {    // Êý¾Ý½á¹û»º³åÇø
 125                                                                                                  // 0Í¨µÀ
 126                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 127                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 128                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0',
 129                                                                                                  // 1Í¨µÀ 
 130                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 131                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 132                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 133                                                                                                  // 2Í¨µÀ
 134                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 135                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 136                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 137                                                                                                  // 3Í¨µÀ
 138                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 139                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 140                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0',
 141                                                                                                  // 4Í¨µÀ 
 142                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 143                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 144                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 145                                                                                                  // 5Í¨µÀ
 146                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 147                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 148                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 149                                                                                                  // 6Í¨µÀ
 150                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 151                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 152                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 153                                                                                                  // 7Í¨µÀ
 154                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 155                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 156                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0'
 157                                                                                          };
 158          
 159                          */
 160          
 161          
 162          unsigned  char   xdata  Measure_Buf[8][4]  = {
 163                                                                                                     0x00 ,0x00 ,0x00 ,0x00 ,        //1Â·µçÑ¹Öµ, µçÁ÷Öµ  //¹¦ÂÊ
 164                                                         0x00 ,0x00 ,0x00 ,0x00 ,
 165                                                                                                 0x00 ,0x00 ,0x00 ,0x00 ,
 166                                                                                                 0x00 ,0x00 ,0x00 ,0x00 ,
 167                                                                                                 0x00 ,0x00 ,0x00 ,0x00 ,
 168                                                                                             0x00 ,0x00 ,0x00 ,0x00 ,
 169                                                                                                     0x00 ,0x00 ,0x00 ,0x00 ,
 170                                                                                                 0x00 ,0x00 ,0x00 ,0x00     //8 Â·
 171                                                        };
 172          
 173          
 174          unsigned  int xdata    measure_ma[8][2]={
 175                                                                                                  0x0000 ,0x0000 ,           //1Â·µçÑ¹Âë £¬ µçÁ÷Âë        
 176                                                          0x0000 ,0x0000 ,
 177                                                                                                  0x0000 ,0x0000 ,
C51 COMPILER V9.00   C_MAIN                                                                04/28/2014 09:24:44 PAGE 4   

 178                                                                                                  0x0000 ,0x0000 ,
 179                                                                                                  0x0000 ,0x0000 ,
 180                                                                                              0x0000 ,0x0000 ,
 181                                                                                                          0x0000 , 0x0000,
 182                                                                                                          0x0000 , 0x0000
 183                                                                                                  };
 184          
 185          
 186          //unsigned  char xdata    measure_sys[6][4]={
 187          //                                                                                      0x00 ,0x00 ,0x00 ,0x00 ,           //1Â·µçÑ¹ ÏµÊýµç   Á÷ £¬     ÏµÊý
 188           //                                               0x00 ,0x00 ,0x00 ,0x00 ,                                                              
 189          //                                                                                      0x00 ,0x00 ,0x00 ,0x00 ,
 190          //                                                                                      0x00 ,0x00 ,0x00 ,0x00 ,
 191          //                                                                                      0x00 ,0x00 ,0x00 ,0x00 ,
 192          //                                                                                  0x00 ,0x00 ,0x00 ,0x00 
 193          //                                                                                      };
 194          
 195          //unsigned  int   idata   v_sys[6]={ 0xd9c7 ,0xd9c7 ,0xd9c7,0xd9c7,0xd9c7,0xd9c7  };    //ÁùÂ·µçÑ¹ÏµÊý    r=21
             -5kÏµÊý=d9c7  (26000*65536/30563)
 196            unsigned  int   idata   v_sys= 0xd9c7 ;
 197          
 198          
 199          //      float code conVoltage_Cof = (25000.0*0.98* 5.0 / 16777216.0);
 200                  //      float code conCurrent_Cof = (25000.0 * 5.0 / 16777216.0);
 201                  //      float code   conPower_Cof = (250.0*250.0 / 8388608.0);
 202          
 203          //          unsigned  int  code   conVoltage_sys=0xf522;         //         25400*65536/26526           =0xf522                 r=250k  
 204          unsigned   int   code    conCurrent_sys=0x4ed;           // 408*65536/52ce                a=4.08                   ma=52ce
 205          unsigned char xdata Parameter_Buf[ 6 * 3 + 1 ]; // ²ÎÊý»º³åÇø
 206          
 207          unsigned char idata Read_State = 0;
 208          
 209          /*=======================================================================
 210                                  CS5460±êÖ¾Î»´¦Àí
 211          =======================================================================*/
 212          unsigned char bdata CS5460_Flag0;
 213          sbit DRDY_Flag = CS5460_Flag0^7;   // Êý¾ÝÓÐÐ§±êÖ¾ ÔÚÁ¬Ðø»òµ¥´Î×ª»»Ä£Ê½ÏÂ±íÃ÷¼ÆËã½á¹ûÒÑ¾­¾ÍÐ÷£¬ÔÚÐ£×¼Ä£Ê½Ï
             -Â±íÊ¾Ð£×¼Êý¾ÝÒÑ¾­Ð´Èëµ½ÏàÓ¦µÄ¼Ä´æÆ÷
 214          sbit EOUT_Flag = CS5460_Flag0^6; 
 215          sbit EDIR_Flag = CS5460_Flag0^5; 
 216          sbit CRDY_Flag = CS5460_Flag0^4; 
 217          sbit MATH_Flag = CS5460_Flag0^3; 
 218          //sbit RES_Flag  = CS5460_Flag0^2; 
 219          sbit IOR_Flag  = CS5460_Flag0^1; 
 220          sbit VOR_Flag  = CS5460_Flag0^0; 
 221          
 222          unsigned char bdata CS5460_Flag1;
 223          sbit PWOR_Flag = CS5460_Flag1^7; 
 224          sbit IROR_Flag = CS5460_Flag1^6; 
 225          sbit VROR_Flag = CS5460_Flag1^5; 
 226          sbit EOR_Flag  = CS5460_Flag1^4; 
 227          sbit EOOR_Flag = CS5460_Flag1^3; 
 228          //sbit RES_Flag  = CS5460_Flag1^2; 
 229          sbit ID3_Flag  = CS5460_Flag1^1; 
 230          sbit ID2_Flag  = CS5460_Flag1^0;
 231          
 232          unsigned char bdata CS5460_Flag2;
 233          sbit ID1_Flag = CS5460_Flag2^7; 
 234          sbit ID0_Flag = CS5460_Flag2^6; 
 235          sbit WDT_Flag = CS5460_Flag2^5; 
 236          sbit VOD_Flag = CS5460_Flag2^4; 
 237          sbit IOD_Flag = CS5460_Flag2^3; 
C51 COMPILER V9.00   C_MAIN                                                                04/28/2014 09:24:44 PAGE 5   

 238          sbit LSD_Flag = CS5460_Flag2^2; 
 239          //sbit 0_Flag   = CS5460_Flag2^1; 
 240          sbit nIC_Flag = CS5460_Flag2^0;
 241          
 242          long idata CS5460_Status;  // CS5460µÄ×´Ì¬×Ö
 243          
 244          unsigned char idata CS5460_CabNum;  
 245                                                                                          
 246          //unsigned char code con_ChannelChange[] = { 1, 4, 5, 7, 3 , 6 };
 247          
 248          //unsigned char code con_ChannelChange[] = { 1, 4, 5, 2, 3 , 6 };
 249          
 250          
 251          //unsigned char code con_ChannelChange[] = { 1,2, 3, 4, 5 , 6 };
 252          unsigned char code con_ChannelChange[] = { 0,1,2, 3, 4, 5 , 6,7 };
 253          
 254          unsigned char idata Output_Channel;
 255          
 256          
 257          
 258           void read_vsys(void) ;
 259           void vself_cab(void) ;
 260          
 261          void delaynus (unsigned   char   n)
 262            { unsigned  char i;
 263   1            for(i=0 ;i<=n ;i++) 
 264   1                {_nop_();
 265   2                 _nop_();
 266   2                 }
 267   1                  
 268   1        }
 269          
 270          
 271          
 272          /*=======================================================================
 273          º¯ÊýÃû³Æ£ºstrTostr
 274          º¯Êý¹¦ÄÜ: ×Ö·û´®´«ËÍº¯Êý
 275          ÊäÈë²ÎÊý£º
 276          Êä³ö²ÎÊý£ºÎÞ
 277          ·µ »Ø Öµ£ºÎÞ
 278          ÆäËüËµÃ÷£º
 279          =======================================================================*/
 280          /*
 281          void strTostr( unsigned char *srcP, unsigned char *dstP, unsigned char Number ){
 282          
 283                  unsigned char i;
 284          
 285                  for( i = 0; i < Number; i++ ){ *srcP++ = *dstP++; }
 286          
 287          }
 288          
 289           */
 290          
 291          
 292          
 293          
 294          unsigned   char     strTostr( unsigned char *srcP, unsigned char *dstP, unsigned char Number ){
 295   1      
 296   1              unsigned char i ,temp  =0;
 297   1              for( i = 0; i < Number; i++ )
 298   1           { 
 299   2                 temp += *dstP;
C51 COMPILER V9.00   C_MAIN                                                                04/28/2014 09:24:44 PAGE 6   

 300   2                 *srcP++ = *dstP++; 
 301   2                 
 302   2            }
 303   1              return(temp);
 304   1      
 305   1      }
 306          
 307          
 308          
 309          
 310          
 311          /*=======================================================================
 312          º¯ÊýÃû³Æ£ºHexASCIIToBin
 313          º¯Êý¹¦ÄÜ£º
 314          ÊäÈë²ÎÊý£º
 315          Êä³ö²ÎÊý£ºÎÞ
 316          ·µ »Ø Öµ£ºÎÞ
 317          ÆäËüËµÃ÷£º
 318          =======================================================================*/
 319          unsigned char HexASCIIToBin( unsigned char CVT_Data ){
 320   1      
 321   1              if( CVT_Data >= '0' && CVT_Data <= '9' ){ return ( CVT_Data - '0'); }
 322   1              else                                    { return ( CVT_Data - 'A' + 10 ); }
 323   1      
 324   1      }
 325          
 326          /*=======================================================================
 327          º¯ÊýÃû³Æ£ºLongToASCII
 328          º¯Êý¹¦ÄÜ£ºÕûÐÎÊý×ª»»ÎªASCII
 329          ÊäÈë²ÎÊý£º
 330          Êä³ö²ÎÊý£ºÎÞ
 331          ·µ »Ø Öµ£ºÎÞ
 332          ÆäËüËµÃ÷£º
 333          =======================================================================*/
 334          void LongToASCII( unsigned char *p, unsigned long CVT_Data, unsigned char Type_Flag ){
 335   1      
 336   1              *p++ = ' ';
 337   1              *p++ = con_HexCode[ CVT_Data / 100000 ];
 338   1              *p++ = con_HexCode[ CVT_Data % 100000 / 10000 ];
 339   1              if( Type_Flag == 'I' ){ *p++ = '.'; }
 340   1              *p++ = con_HexCode[ CVT_Data % 10000 / 1000 ];
 341   1              *p++ = con_HexCode[ CVT_Data % 1000 / 100 ];
 342   1              if( Type_Flag == 'V' || Type_Flag == 'P' ){ *p++ = '.'; }
 343   1              *p++ = con_HexCode[ CVT_Data % 100 / 10 ];
 344   1              *p++ = con_HexCode[ CVT_Data % 10 ];
 345   1      
 346   1      }
 347          
 348          /*=======================================================================
 349          º¯ÊýÃû³Æ£ºUART0_UnPacket
 350          º¯Êý¹¦ÄÜ£º´®ÐÐ¿Ú½â°üº¯Êý
 351          ÊäÈë²ÎÊý£ºÎÞ
 352          Êä³ö²ÎÊý£ºÎÞ
 353          ·µ »Ø Öµ£ºÎÞ
 354          ÆäËüËµÃ÷£º
 355          =======================================================================*/
 356          /*=======================================================================
 357          Êý¾ÝÏÂ´«¸ñÊ½ÈçÏÂ£º
 358          0123456789ABCDEF0123456
 359          [@0F$D#01-00        CR]£º±íÊ¾¶ÁÈ¡ZZµØÖ·µ¥Æ¬»úµÄYYÍ¨µÀµÄµÚXXÏî²ÎÊý
 360                                                   µ±XX=FFÊ±±íÊ¾£¬Ò»´Î»ñÈ¡ÆäYYÍ¨µÀµÄËùÓÐ²ÎÊý
 361          [@0F$R# R-0C        CR]£º±íÊ¾¶ÁÈ¡FµØÖ·µ¥Æ¬»úµÄXXµØÖ·¼Ä´æÆ÷µÄÄÚÈÝ
C51 COMPILER V9.00   C_MAIN                                                                04/28/2014 09:24:44 PAGE 7   

 362          
 363          [@ZZ$W# R-XX|FFFFFF CR]£º±íÊ¾Ð´ZZµØÖ·µ¥Æ¬»úµÄXX¼Ä´æÆ÷µÄÄÚÈÝ
 364          
 365          [@ZZ$S# T-Cnn       CR]£º±íÊ¾Ð´ZZµØÖ·µ¥Æ¬»úµÄÊý¾Ý×Ô¶¯ÉÏ´«¹¦ÄÜµÄÉèÖÃ
 366                                   nn±íÊ¾Ê±¼ä¼ä¸ôµ¥Î»Ãë
 367                                                   nn=00Ê±±íÊ¾½ûÖ¹×Ô¶¯Á¬ÐøÉÏ´«¹¦ÄÜ
 368          [@ZZ$S# S-4800,8,1,0CR]£º´®ÐÐ¿Ú²¨ÌØÂÊÉèÖÃ
 369          [@ZZ$S# A-XX        CR]£ºÉèÖÃZZµ¥Æ¬»úµÄÍ¨Ñ¶µØÖ·ÎªXX
 370          [FDF]
 371          [FCX]
 372          01234
 373          =======================================================================*/
 374          /*
 375          void UART0_UnPacket( void ){    
 376          
 377                  switch( UART0_ReceBuf[2] ){
 378                          case 'D': // ÒªÊý¾ÝµÄÃüÁî
 379                                          UART0_TranChannel   = HexASCIIToBin( UART0_ReceBuf[3] );
 380                                          if( UART0_TranChannel < 6 ){
 381                                              UART0_TranState = 'D';
 382                                          }                                
 383                                          break;
 384                          case 'C': 
 385                                          CS5460_CabNum = HexASCIIToBin( UART0_ReceBuf[3] );
 386                                          UART0_TranState = 'A'; // »Ø¸´ÕýÈ·Ó¦´ðÃüÁî
 387                                          System_State = conSysCabState; State_Timer = 0;  
 388                                          break;
 389                          default: UART0_TranState = 'Z'; break;
 390          
 391                  }
 392          
 393          }
 394          
 395          */
 396          
 397          
 398          
 399          void UART0_UnPacket( void ){    
 400   1      
 401   1              switch(  UART0_ReceBuf[3]){
 402   2                      case   0x03: // ÒªÊý¾ÝµÄÃüÁî
 403   2                              //      UART0_TranChannel   = HexASCIIToBin( UART0_ReceBuf[3] );
 404   2                              //      if( UART0_TranChannel < 6 ){
 405   2                              //          UART0_TranState = 'D';
 406   2                              //      }       
 407   2                                      UART0_TranState = 'D';
 408   2                                      break;
 409   2                      case 0x05:         //ÏµÍ³±ê¶¨
 410   2                                            //        CS5460_CabNum = HexASCIIToBin( UART0_ReceBuf[3] );
 411   2                      CS5460_CabNum = UART0_ReceBuf[4]; // ÕÒcon_CabTab[]        ÖÐ¶ÔÓ¦µÄÄÚÈÝ
 412   2                                      UART0_TranState = 'C'; // »Ø¸´ÕýÈ·Ó¦´ðÃüÁî
 413   2                                      System_State = conSysCabState; State_Timer = 0;  //
 414   2                      
 415   2                                      break;   //
 416   2                      case 0x06: 
 417   2                                      vself_cab( );
 418   2                                              break;
 419   2      
 420   2                      default: UART0_TranState = 'Z'; break;
 421   2      
 422   2              }
 423   1      
C51 COMPILER V9.00   C_MAIN                                                                04/28/2014 09:24:44 PAGE 8   

 424   1      }
 425          
 426          
 427          
 428          
 429          
 430          /*=======================================================================
 431          º¯ÊýÃû³Æ£ºUART0_Packet
 432          º¯Êý¹¦ÄÜ£º´¦Àí´®ÐÐ¿ÚÒª·¢ËÍµÄÊý¾Ý°ü ²¢×Ô¶¯Æô¶¯·¢ËÍ
 433          ÊäÈë²ÎÊý£º
 434          Êä³ö²ÎÊý£ºÎÞ
 435          ·µ »Ø Öµ£ºÎÞ
 436          ÆäËüËµÃ÷£º
 437          =======================================================================*/
 438          /*
 439          void UART0_Packet( void ){
 440          
 441                  UART0_TranBuf[0] = '[';                                   // ·ÅÈëÆðÊ¼×Ö·û
 442                  UART0_TranBuf[1] = Device_Address;  // ·ÅÈëµØÖ·
 443                  // ÉÏ´«Êý¾Ý´ò°ü¹ý³Ì
 444                  switch( UART0_TranState ){              
 445                          case 'D': // ÉÏ´«²É¼¯µ½µÄÊý¾ÝÃüÁî
 446                                  UART0_TranBuf[ 2] = con_HexCode[ UART0_TranChannel ];
 447                                          // È«²¿²ÎÊýÉÏ´«
 448                                          strTostr( &UART0_TranBuf[3],  &Measure_Buf[UART0_TranChannel][0], 8 );
 449                                          strTostr( &UART0_TranBuf[11], &Measure_Buf[UART0_TranChannel][1], 8 );
 450                                  //      strTostr( &UART0_TranBuf[19], &Measure_Buf[UART0_TranChannel][2], 8 );
 451                                          UART0_TranBuf[19] = ']';
 452                                          UART0_TranMaxNum = 20;
 453                                          break;   
 454                          case 'C':  // ÉÏ´«Íê³É×´Ì¬ [@ZZ$C# XOK     |CRC]£º
 455                                          UART0_TranBuf[ 2] = 'C'; 
 456                                          UART0_TranBuf[ 3] = con_HexCode[ CS5460_CabNum ];
 457                                          UART0_TranBuf[ 4] = 'O'; 
 458                                          UART0_TranBuf[ 5] = 'K'; 
 459                                          UART0_TranBuf[ 6] = ']'; 
 460                                          UART0_TranMaxNum = 7;
 461                                          break;
 462                          case 'A':  // ÉÏ´«ÕýÈ·Ó¦´ð×´Ì¬ [@ZZ$S# ACK|CRC]£º
 463                                          UART0_TranBuf[ 2] = 'A'; 
 464                                          UART0_TranBuf[ 3] = 'C'; 
 465                                          UART0_TranBuf[ 4] = 'K'; 
 466                                          UART0_TranBuf[ 5] = ']'; 
 467                                          UART0_TranMaxNum = 6;
 468                                          break;
 469                          case 'Z':  // ÉÏ´«ÎÞ·¨Ó¦´ð×´Ì¬ 
 470                                          UART0_TranBuf[ 2] = 'n'; 
 471                                          UART0_TranBuf[ 3] = 'A'; 
 472                                          UART0_TranBuf[ 4] = 'C'; 
 473                                          UART0_TranBuf[ 5] = 'K';                                         
 474                                          UART0_TranBuf[ 6] = ']';
 475                                          UART0_TranMaxNum = 7;
 476                                          break;
 477                          default: break;
 478                  }
 479              UART0_TranCounter = 0;
 480                  Max485_Tran;             // 485·¢ËÍÊ¹ÄÜ
 481                  TI = 1;  // °ÑÊý¾Ý·¢ËÍ³öÈ¥
 482                  UART0_TranState = 0;
 483          
 484          }
 485          
C51 COMPILER V9.00   C_MAIN                                                                04/28/2014 09:24:44 PAGE 9   

 486            */
 487          
 488          
 489          
 490          void UART0_Packet( void ){
 491   1               unsigned  char   chkdata;
 492   1              UART0_TranBuf[0] = 0x6c;                                          // ·ÅÈëÆðÊ¼×Ö·û
 493   1              UART0_TranBuf[1] = 0x63;
 494   1              UART0_TranBuf[2] = Device_Address;  // ·ÅÈëµØÖ·
 495   1              // ÉÏ´«Êý¾Ý´ò°ü¹ý³Ì
 496   1              switch( UART0_TranState ){              
 497   2                      case 'D': // ÉÏ´«²É¼¯µ½µÄÊý¾ÝÃüÁî
 498   2                            //  UART0_TranBuf[ 2] = con_HexCode[ UART0_TranChannel ];
 499   2                                      // È«²¿²ÎÊýÉÏ´«
 500   2                                        chkdata= strTostr( &UART0_TranBuf[3],  &Measure_Buf[0], 32 );
 501   2                                   //  chkdata= strTostr( &UART0_TranBuf[3],  &Measure_Buf[0], 24 );
 502   2                                       //     strTostr( &UART0_TranBuf[11], &Measure_Buf[UART0_TranChannel][1], 8 );
 503   2      
 504   2                              //      strTostr( &UART0_TranBuf[19], &Measure_Buf[UART0_TranChannel][2], 8 );
 505   2                                      chkdata += UART0_TranBuf[2];
 506   2                                      UART0_TranBuf[35] = chkdata;      //chk
 507   2                                      UART0_TranBuf[36] = 0x0d;
 508   2                                      UART0_TranMaxNum = 37;
 509   2                                 // chkdata += UART0_TranBuf[2];
 510   2                              //      UART0_TranBuf[27] = chkdata;      //chk
 511   2                              //      UART0_TranBuf[28] = 0x0d;
 512   2                              //      UART0_TranMaxNum = 29;
 513   2                                      break;   
 514   2                      case 'C':  // ÉÏ´«Íê³É×´Ì¬ [@ZZ$C# XOK     |CRC]£º
 515   2                              //      UART0_TranBuf[ 3] = 'C'; 
 516   2                              //      UART0_TranBuf[ 4] = con_HexCode[ CS5460_CabNum ];
 517   2                              //      UART0_TranBuf[ 5] = 'O'; 
 518   2                              //      UART0_TranBuf[ 6] = 'K'; 
 519   2                              //      UART0_TranBuf[ 7] = ']'; 
 520   2                                      UART0_TranBuf[ 3] = Parameter_Buf[17]; 
 521   2                                      UART0_TranBuf[ 4] = Parameter_Buf[16];
 522   2                                      UART0_TranBuf[ 5] = Parameter_Buf[15]; 
 523   2                                      UART0_TranBuf[ 6] = Parameter_Buf[11]; 
 524   2                                      UART0_TranBuf[ 7] = Parameter_Buf[10];
 525   2                                      UART0_TranBuf[ 8] = Parameter_Buf[9];
 526   2      
 527   2      
 528   2      
 529   2                                      UART0_TranMaxNum = 9;
 530   2                                      break;
 531   2                      case 'A':  // ÉÏ´«ÕýÈ·Ó¦´ð×´Ì¬ [@ZZ$S# ACK|CRC]£º
 532   2                                      UART0_TranBuf[ 3] = 'A'; 
 533   2                                      UART0_TranBuf[ 4] = 'C'; 
 534   2                                      UART0_TranBuf[ 5] = 'K'; 
 535   2                                      UART0_TranBuf[ 6] = ']'; 
 536   2                                      UART0_TranMaxNum = 7;
 537   2                                      break;
 538   2                      case 'Z':  // ÉÏ´«ÎÞ·¨Ó¦´ð×´Ì¬ 
 539   2                                      UART0_TranBuf[ 3] = 'n'; 
 540   2                                      UART0_TranBuf[ 4] = 'A'; 
 541   2                                      UART0_TranBuf[ 5] = 'C'; 
 542   2                                      UART0_TranBuf[ 6] = 'K';                                         
 543   2                                      UART0_TranBuf[ 7] = ']';
 544   2                                      UART0_TranMaxNum = 8;
 545   2                                      break;
 546   2                      default: break;
 547   2              }
C51 COMPILER V9.00   C_MAIN                                                                04/28/2014 09:24:44 PAGE 10  

 548   1          UART0_TranCounter = 0;
 549   1              Max485_Tran;             // 485·¢ËÍÊ¹ÄÜ
 550   1              TI = 1;  // °ÑÊý¾Ý·¢ËÍ³öÈ¥
 551   1              UART0_TranState = 0;
 552   1      
 553   1      }
 554          
 555          
 556          
 557          
 558          /*=======================================================================
 559          º¯ÊýÃû³Æ£ºGet_Parameter
 560          º¯Êý¹¦ÄÜ£º»ñÈ¡²ÎÊýÖµ, Í¬Ê±ÅäÖÃCS5460
 561          ÊäÈë²ÎÊý£ºÎÞ
 562          Êä³ö²ÎÊý£ºÎÞ
 563          ·µ »Ø Öµ£ºÎÞ
 564          ÆäËüËµÃ÷£º
 565          =======================================================================*/
 566          void Get_Parameter( void ){
 567   1      
 568   1              unsigned char i;
 569   1              unsigned  int Parameter_Address;
 570   1      
 571   1              Parameter_Address = 0;
 572   1      
 573   1              for( i = 0; i < (6 * 3 + 1); i++ ){
 574   2                      Parameter_Buf[i] = ISP_Byte_Read( Parameter_Address++ );
 575   2              }
 576   1      
 577   1              // Èç¹û²ÎÊýÕýÈ· ÔòÅäÖÃCS5460
 578   1              if( Parameter_Buf[ ( 6*3 ) ] == 0x00 ){ 
 579   2                      CS5460_WriteReg( addIDCOffset, Parameter_Buf[ 2 ], Parameter_Buf[ 1 ], Parameter_Buf[ 0 ] );
 580   2                      CS5460_WriteReg( addIGain,     Parameter_Buf[ 5 ], Parameter_Buf[ 4 ], Parameter_Buf[ 3 ] );
 581   2                      CS5460_WriteReg( addVDCOffset, Parameter_Buf[ 8 ], Parameter_Buf[ 7 ], Parameter_Buf[ 6 ] );
 582   2                      CS5460_WriteReg( addVGain,     Parameter_Buf[ 11 ], Parameter_Buf[ 10 ], Parameter_Buf[ 9 ] );
 583   2                      CS5460_WriteReg( addIACOffset, Parameter_Buf[ 14 ], Parameter_Buf[ 13 ], Parameter_Buf[ 12 ] );
 584   2                      CS5460_WriteReg( addVACOffset, Parameter_Buf[ 17 ], Parameter_Buf[ 16 ], Parameter_Buf[ 15 ] );
 585   2              }
 586   1      
 587   1      }
 588          
 589           /*
 590          void Get_Parameter( void ){
 591          
 592                  unsigned char i;
 593                  unsigned  int Parameter_Address;
 594          
 595                  Parameter_Address = 0;
 596          
 597                  for( i = 0; i < (6 * 3 + 1); i++ ){
 598                          Parameter_Buf[i] = ISP_Byte_Read( Parameter_Address++ );
 599                  }
 600          
 601                  // Èç¹û²ÎÊýÕýÈ· ÔòÅäÖÃCS5460
 602                  if( Parameter_Buf[ ( 6*3 ) ] == 0x00 ){ 
 603                          CS5460_WriteReg( addIDCOffset, Parameter_Buf[ 0 ], Parameter_Buf[ 1 ], Parameter_Buf[ 2 ] );
 604                          CS5460_WriteReg( addIGain,     Parameter_Buf[ 3 ], Parameter_Buf[ 4 ], Parameter_Buf[ 5 ] );
 605                          CS5460_WriteReg( addVDCOffset, Parameter_Buf[ 6 ], Parameter_Buf[ 7 ], Parameter_Buf[ 8 ] );
 606                          CS5460_WriteReg( addVGain,     Parameter_Buf[ 9 ], Parameter_Buf[ 10 ], Parameter_Buf[ 11 ] );
 607                          CS5460_WriteReg( addIACOffset, Parameter_Buf[ 12 ], Parameter_Buf[ 13 ], Parameter_Buf[ 14 ] );
 608                          CS5460_WriteReg( addVACOffset, Parameter_Buf[ 15 ], Parameter_Buf[ 16 ], Parameter_Buf[ 17 ] );
 609                  }
C51 COMPILER V9.00   C_MAIN                                                                04/28/2014 09:24:44 PAGE 11  

 610          
 611          }
 612          
 613           */
 614          
 615          /*=======================================================================
 616          º¯ÊýÃû³Æ£ºSave_Parameter
 617          º¯Êý¹¦ÄÜ£º±£´æ²ÎÊýÖµ
 618          ÊäÈë²ÎÊý£ºÎÞ
 619          Êä³ö²ÎÊý£ºÎÞ
 620          ·µ »Ø Öµ£ºÎÞ
 621          ÆäËüËµÃ÷£º
 622          =======================================================================*/
 623          void Save_Parameter( void ){
 624   1      
 625   1              unsigned char i;
 626   1              unsigned  int Parameter_Address;
 627   1      
 628   1              Parameter_Address = 0;
 629   1              Sector_Erase( Parameter_Address );
 630   1      
 631   1              CS5460_Status = CS5460_ReadReg( addIDCOffset );
 632   1              Parameter_Buf[ 0 ]  = CS5460_Status;     
 633   1              Parameter_Buf[ 1 ]  = ( CS5460_Status >> 8 );
 634   1              Parameter_Buf[ 2 ]  = ( CS5460_Status   >> 16 );
 635   1      
 636   1              CS5460_Status = CS5460_ReadReg( addIGain );
 637   1              Parameter_Buf[ 3 ]  = CS5460_Status;     
 638   1              Parameter_Buf[ 4 ]  = ( CS5460_Status >> 8 );
 639   1              Parameter_Buf[ 5 ]  = ( CS5460_Status   >> 16 );
 640   1      
 641   1              CS5460_Status = CS5460_ReadReg( addVDCOffset );
 642   1              Parameter_Buf[ 6 ]  = CS5460_Status;     
 643   1              Parameter_Buf[ 7 ]  = ( CS5460_Status >> 8 );
 644   1              Parameter_Buf[ 8 ]  = ( CS5460_Status   >> 16 );
 645   1      
 646   1      
 647   1              CS5460_Status = CS5460_ReadReg( addVGain );
 648   1              Parameter_Buf[ 9 ]  = CS5460_Status;     
 649   1              Parameter_Buf[ 10 ]  = ( CS5460_Status >> 8 );
 650   1              Parameter_Buf[ 11 ]  = ( CS5460_Status  >> 16 );
 651   1      
 652   1              CS5460_Status = CS5460_ReadReg( addIACOffset );
 653   1              Parameter_Buf[ 12 ]  = CS5460_Status;    
 654   1              Parameter_Buf[ 13 ]  = ( CS5460_Status >> 8 );
 655   1              Parameter_Buf[ 14 ]  = ( CS5460_Status  >> 16 );
 656   1      
 657   1              CS5460_Status = CS5460_ReadReg( addVACOffset );
 658   1              Parameter_Buf[ 15 ]  = CS5460_Status;    
 659   1              Parameter_Buf[ 16 ]  = ( CS5460_Status >> 8 );
 660   1              Parameter_Buf[ 17 ]  = ( CS5460_Status  >> 16 );
 661   1      
 662   1              Parameter_Buf[ 18 ]  = 0x00;
 663   1      
 664   1              for( i = 0; i < (6 * 3 + 1); i++ ){
 665   2                      ISP_Byte_Write( Parameter_Address++, Parameter_Buf[i] );
 666   2              }
 667   1      
 668   1      }
 669          
 670          
 671          /*=======================================================================
C51 COMPILER V9.00   C_MAIN                                                                04/28/2014 09:24:44 PAGE 12  

 672          º¯ÊýÃû³Æ£ºSystem_PowerOn
 673          º¯Êý¹¦ÄÜ£ºÏµÍ³¸ÕÉÏµçÐèÒª´¦ÀíµÄÊÂÇé
 674          ÊäÈë²ÎÊý£ºÎÞ
 675          Êä³ö²ÎÊý£ºÎÞ
 676          ·µ »Ø Öµ£ºÎÞ
 677          ÆäËüËµÃ÷£º1¡¢ÑÓÊ±1S
 678                            2¡¢Ö¸Ê¾µÆÒÔ0.3SÉÁË¸
 679                            3¡¢Ê¹ÄÜµçÑ¹Í¨µÀ£¬µçÁ÷Í¨µÀ£¬ÇÐ»»µ½0Í¨µÀ
 680                            4¡¢¸´Î»CS5460
 681                            5¡¢Ìø×ªµ½ÏµÍ³¿ÕÏÐ×´Ì¬
 682          =======================================================================*/
 683          void System_PowerOn( void ){
 684   1      
 685   1              // Ö¸Ê¾µÆÒÔ0.3SÉÁË¸
 686   1              if( (State_Timer % 30) == 0 ) { SystemLED_Flag = ~SystemLED_Flag; }
 687   1      
 688   1              // Ê¹ÄÜµçÑ¹Í¨µÀ£¬µçÁ÷Í¨µÀ£¬ÇÐ»»µ½0Í¨µÀ ¸´Î»CS5460
 689   1              if( State_Timer == 100 ){
 690   2                      CS5460_RSTLow;
 691   2                      CS5460_Channel = 0;
 692   2                      CD4051_A = 0;
 693   2                      //CD4051_A = 1;
 694   2                      CD4051_B = 0;
 695   2                      CD4051_C = 0;
 696   2                      CD4051_EN0 = 0;
 697   2                      CD4051_EN1 = 0;
 698   2      
 699   2              }
 700   1              if( State_Timer == 103 ){ CS5460_RSTHigh; } // ¸´Î»Íê³É
 701   1      
 702   1              // Í¬²½CS5460µÄ´®ÐÐ¿Ú
 703   1              if( State_Timer == 104 ){
 704   2                      CS5460_CSLow;
 705   2                      CS5460_Send( cmdSYNC1 );  // 
 706   2                      CS5460_Send( cmdSYNC1 );  // 
 707   2                      CS5460_Send( cmdSYNC1 );  // 
 708   2                      CS5460_Send( cmdSYNC0 );  // 
 709   2                      CS5460_CSHigh;
 710   2              
 711   2                      CS5460_WriteReg( addConfig, 0x00, 0x10, 0x63 ); // ÅäÖÃConfig
 712   2              //      CS5460_WriteReg( addConfig, 0x00, 0x10, 0x03 ); // ÅäÖÃConfig
 713   2              //      Get_Parameter();   //¶Á±ê¶¨²ÎÊý  µ½cs5460ÖÐ
 714   2                  read_vsys(); //´Óeeprom   ÖÐ¶ÁÈËÏµÊýµ½v¡ª¡ª¡ªsys¡¾¡¿Êý×éÖÐ
 715   2              }                                          
 716   1      
 717   1              if( State_Timer == 106 ){                       
 718   2                      CS5460_SendCmd( cmdStartCVTCtinu );  // ·¢ËÍÁ¬ÐøÆô¶¯×ª»»ÃüÁî  
 719   2                      // »ñÈ¡Éè±¸µØÖ·
 720   2                      Device_Address = P1;
 721   2                      Device_Address >>= 4;
 722   2              //      Device_Address = Device_Address & 0x03;//p1.4 p1.5
 723   2              //      Device_Address =  con_HexCode[Device_Address];
 724   2                      System_State = conSysIDLEState; State_Timer = 0;  // 1Ãëºó Ìø×ªµ½ÏµÍ³¿ÕÏÐ×´Ì¬
 725   2                      Max485_Rece;
 726   2              }
 727   1      
 728   1      }
 729          
 730           /*
 731          void System_PowerOn( void ){
 732          
 733                  // Ö¸Ê¾µÆÒÔ0.3SÉÁË¸
C51 COMPILER V9.00   C_MAIN                                                                04/28/2014 09:24:44 PAGE 13  

 734                  if( (State_Timer % 30) == 0 ) { SystemLED_Flag = ~SystemLED_Flag; }
 735          
 736                  // Ê¹ÄÜµçÑ¹Í¨µÀ£¬µçÁ÷Í¨µÀ£¬ÇÐ»»µ½0Í¨µÀ ¸´Î»CS5460
 737                  if( State_Timer == 100 ){
 738                          CS5460_RSTLow;
 739                          CS5460_Channel = 0;
 740                          CD4051_A = 1;
 741                          CD4051_B = 0;
 742                          CD4051_C = 0;
 743                          CD4051_EN0 = 0;
 744                          CD4051_EN1 = 0;
 745          
 746                  }
 747                  if( State_Timer == 103 ){ CS5460_RSTHigh; } // ¸´Î»Íê³É
 748          
 749                  // Í¬²½CS5460µÄ´®ÐÐ¿Ú
 750                  if( State_Timer == 104 ){
 751                          CS5460_CSLow;
 752                          CS5460_Send( cmdSYNC1 );  // 
 753                          CS5460_Send( cmdSYNC1 );  // 
 754                          CS5460_Send( cmdSYNC1 );  // 
 755                          CS5460_Send( cmdSYNC0 );  // 
 756                          CS5460_CSHigh;
 757                  
 758                          CS5460_WriteReg( addConfig, 0x00, 0x10, 0x63 ); // ÅäÖÃConfig
 759                  }
 760          
 761                  if( State_Timer == 106 ){                       
 762                          CS5460_SendCmd( cmdStartCVTCtinu );  // ·¢ËÍÁ¬ÐøÆô¶¯×ª»»ÃüÁî  
 763                          // »ñÈ¡Éè±¸µØÖ·
 764                          Device_Address = P1;
 765                          Device_Address >>= 4;
 766                  //      Device_Address =  con_HexCode[Device_Address];
 767                          System_State = conSysIDLEState; State_Timer = 0;  // 1Ãëºó Ìø×ªµ½ÏµÍ³¿ÕÏÐ×´Ì¬
 768                          Max485_Rece;
 769                  }
 770          
 771          }
 772          
 773          
 774           */
 775          
 776          /*=======================================================================
 777          º¯ÊýÃû³Æ£ºSystem_IDLE
 778          º¯Êý¹¦ÄÜ£ºÏµÍ³¿ÕÏÐÐèÒª´¦ÀíµÄÊÂÇé
 779          ÊäÈë²ÎÊý£ºÎÞ
 780          Êä³ö²ÎÊý£ºÎÞ
 781          ·µ »Ø Öµ£ºÎÞ
 782          ÆäËüËµÃ÷£º1¡¢Ö¸Ê¾µÆÒÔ1SÉÁË¸
 783                            2¡¢Ã¿Ò»ÃëÇÐ»»Ò»´ÎÍ¨µÀ£¬Æô¶¯CS5460×ª»»Ò»´Î£¬¶ÁÈ¡Ò»´Î×ª»»½á¹û£¬²¢°Ñ½á¹û¸üÐÂµ½ÏàÓ¦µÄ»º³åÇø
 784                            3¡¢Èç¹ûÊÕµ½´®ÐÐ¿ÚÊý¾Ý°ü£¬Ôò½â°ü²¢´¦Àí
 785                            4¡¢Ã¿Ò»ÃëÊý¾Ý´ò°üÒ»´Î£¬²¢Ö÷¶¯ÉÏ´«Ò»´Î£¨µ÷ÊÔÓÃ£©
 786          =======================================================================*/
 787          /*
 788          void System_IDLE( void ){       
 789          
 790                    bit Plus_Flag;
 791                  float Temp_f;
 792                  unsigned long Temp_l;
 793          
 794                  // Ã¿10ms¶ÁÒ»´ÎCS5460µÄ×´Ì¬×Ö£¬¸ù¾Ý×´Ì¬×ÖÀ´ÅÐ¶ÏÏÂÒ»²½µÄ²Ù×÷
 795                  CS5460_Status = CS5460_ReadReg( addStatus );
C51 COMPILER V9.00   C_MAIN                                                                04/28/2014 09:24:44 PAGE 14  

 796                  CS5460_Flag2  = CS5460_Status;   
 797                  CS5460_Flag1  = ( CS5460_Status >> 8 );
 798                  CS5460_Flag0  = ( CS5460_Status >> 16 );
 799                  if( DRDY_Flag == 1 ){ // ¶ÁÈ¡µ±Ç°×ª»»½á¹û                       
 800                          Read_State++;
 801                          if( Read_State != 3 ){
 802                                  // Çå³ý±êÖ¾
 803                                  CS5460_WriteReg( addStatus, CS5460_Flag0, CS5460_Flag1, CS5460_Flag2 );
 804                                  Temp_l = CS5460_ReadReg( addVRMS );
 805                                  Temp_l = CS5460_ReadReg( addIRMS );
 806                                  Temp_l = CS5460_ReadReg( addP );
 807                          }
 808                          if( Read_State >= 3 ){ Read_State = 0;
 809                                  // »ñÈ¡µçÑ¹ÕæÓÐÐ§Öµ                     
 810                                  Temp_f = CS5460_ReadReg( addVRMS ); // ×ª»»Îª¸¡µãÊý
 811                                  Temp_f *= conVoltage_Cof;               // ×ª»»ÎªÐ¡Êý ³ËÉÏÏµÊý
 812                                  Temp_l  = Temp_f;                       // ×ª»»Îª³¤ÕûÐÎÊý
 813                                  // ²ð·Öµ½ÏàÓ¦Í¨µÀµÄÏàÓ¦Ïî»º³åÇø         
 814                                  LongToASCII( &Measure_Buf[CS5460_Channel][0][0], Temp_l, 'V' );
 815                                  // »ñÈ¡µçÁ÷ÕæÓÐÐ§Öµ
 816                                  Temp_f = CS5460_ReadReg( addIRMS );     // ×ª»»Îª¸¡µãÊý
 817                                  Temp_f *= conCurrent_Cof;               // ×ª»»ÎªÐ¡Êý ³ËÉÏÏµÊý
 818                                  Temp_l  = Temp_f;                       // ×ª»»Îª³¤ÕûÐÎÊý
 819                                  // ²ð·Öµ½ÏàÓ¦Í¨µÀµÄÏàÓ¦Ïî»º³åÇø
 820                                  LongToASCII( &Measure_Buf[CS5460_Channel][1][0], Temp_l, 'I' );
 821                                  // »ñÈ¡¹¦ÂÊÖµ
 822                                  Temp_l = CS5460_ReadReg( addP );
 823                                  Plus_Flag = 0;
 824                                  if( Temp_l & 0x00800000 ){ 
 825                                          Plus_Flag = 1; 
 826                                          Temp_l &= 0x007FFFFF; 
 827                                  }
 828                                  Temp_f = Temp_l;        // ×ª»»Îª¸¡µãÊý
 829                                  Temp_f *= conPower_Cof;         // ×ª»»ÎªÐ¡Êý ³ËÉÏÏµÊý
 830                                  Temp_l  = Temp_f;                       // ×ª»»Îª³¤ÕûÐÎÊý
 831                                  // ²ð·Öµ½ÏàÓ¦Í¨µÀµÄÏàÓ¦Ïî»º³åÇø
 832                                  LongToASCII( &Measure_Buf[CS5460_Channel][2][0], Temp_l, 'P' );
 833                                  if( Plus_Flag ) { Measure_Buf[CS5460_Channel][2][0] = '-'; }
 834                                  // Çå³ý±êÖ¾
 835                                  CS5460_WriteReg( addStatus, CS5460_Flag0, CS5460_Flag1, CS5460_Flag2 );
 836                                  // ÇÐ»»Í¨µÀ
 837                                  CS5460_Channel++;
 838                                  if( CS5460_Channel >= 6 ){ CS5460_Channel = 0; }
 839                                  //CS5460_Channel = 1;
 840                                  Output_Channel = con_ChannelChange[ CS5460_Channel ];
 841                                  CD4051_EN0 = 1; 
 842                                  CD4051_EN1 = 1;
 843                                  if( ( Output_Channel & 0x01 ) == 0x01 ){ CD4051_A = 1; }
 844                                  else                                   { CD4051_A = 0; }
 845                                  if( ( Output_Channel & 0x02 ) == 0x02 ){ CD4051_B = 1; }
 846                                  else                                   { CD4051_B = 0; }
 847                                  if( ( Output_Channel & 0x04 ) == 0x04 ){ CD4051_C = 1; }
 848                                  else                                   { CD4051_C = 0; }
 849                                  CD4051_EN0 = 0; 
 850                                  CD4051_EN1 = 0;
 851                          }
 852                          
 853                  }
 854          
 855                  // 1sµ½
 856                  if( ( State_Timer % 100 ) == 0 ){ State_Timer = 0;
 857                          SystemLED_Flag = ~SystemLED_Flag;
C51 COMPILER V9.00   C_MAIN                                                                04/28/2014 09:24:44 PAGE 15  

 858                  }
 859          
 860          }  
 861          
 862           */
 863          
 864          
 865          
 866          void System_IDLE( void ){       
 867   1      
 868   1      //        bit Plus_Flag;
 869   1      //      float Temp_f;
 870   1              unsigned long Temp_l;
 871   1      
 872   1      
 873   1      //      unsigned  char   *p;
 874   1      
 875   1              // Ã¿10ms¶ÁÒ»´ÎCS5460µÄ×´Ì¬×Ö£¬¸ù¾Ý×´Ì¬×ÖÀ´ÅÐ¶ÏÏÂÒ»²½µÄ²Ù×÷
 876   1              CS5460_Status = CS5460_ReadReg( addStatus );
 877   1              CS5460_Flag2  = CS5460_Status;   
 878   1              CS5460_Flag1  = ( CS5460_Status >> 8 );
 879   1              CS5460_Flag0  = ( CS5460_Status >> 16 );
 880   1              if( DRDY_Flag == 1 ){ // ¶ÁÈ¡µ±Ç°×ª»»½á¹û                       
 881   2                      Read_State++;
 882   2                      if( Read_State != 3 ){
 883   3                              // Çå³ý±êÖ¾
 884   3                              CS5460_WriteReg( addStatus, CS5460_Flag0, CS5460_Flag1, CS5460_Flag2 );
 885   3                              Temp_l = CS5460_ReadReg( addVRMS );
 886   3                              Temp_l = CS5460_ReadReg( addIRMS );
 887   3                              Temp_l = CS5460_ReadReg( addP );
 888   3                      }
 889   2                      if( Read_State >= 3 ){ Read_State = 0;
 890   3                              // »ñÈ¡µçÑ¹ÕæÓÐÐ§Öµ                     
 891   3                         //   Temp_f = CS5460_ReadReg( addVRMS ); // ×ª»»Îª¸¡µãÊý
 892   3                         //   Temp_f *= conVoltage_Cof;               // ×ª»»ÎªÐ¡Êý ³ËÉÏÏµÊý
 893   3                        //    Temp_l  = Temp_f;                       // ×ª»»Îª³¤ÕûÐÎÊý
 894   3      
 895   3                                      Temp_l=CS5460_ReadReg(addVRMS);
 896   3                                      Temp_l=Temp_l>>8;                             // yong  2  zhi jie
 897   3                              
 898   3                                      measure_ma[CS5460_Channel][0]=Temp_l;   // cun ri ma ´æÈËµçÑ¹Âëµ½ measure_ma[][] ÖÐ
 899   3                      //              Temp_l=Temp_l* v_sys[CS5460_Channel];
 900   3                                      Temp_l=Temp_l* v_sys;
 901   3                                      Temp_l=Temp_l>>16;
 902   3      
 903   3      
 904   3      
 905   3                              //      Temp_l=Temp_l* conVoltage_sys;
 906   3                              //      Temp_l=Temp_l>>16;
 907   3      
 908   3                              //      p=(unsigned  char *) (&Temp_l);
 909   3                              //      UART0_TranBuf[4]=*p++;            //add
 910   3                              //      UART0_TranBuf[5]=*p++;            //add
 911   3                              //      UART0_TranBuf[6]=*p++;            //add
 912   3                              //      UART0_TranBuf[7]=*p++;            //add
 913   3      
 914   3      
 915   3      
 916   3                              // ²ð·Öµ½ÏàÓ¦Í¨µÀµÄÏàÓ¦Ïî»º³åÇø         
 917   3                      //      LongToASCII( &Measure_Buf[CS5460_Channel][0][0], Temp_l, 'V' );
 918   3                           Measure_Buf[CS5460_Channel][1]=Temp_l;
 919   3                   Measure_Buf[CS5460_Channel][0]=Temp_l>>8;   //´æÈëµçÑ¹Öµµ½measure_buf[][]ÖÐ 
C51 COMPILER V9.00   C_MAIN                                                                04/28/2014 09:24:44 PAGE 16  

 920   3                   
 921   3                              // »ñÈ¡µçÁ÷ÕæÓÐÐ§Öµ
 922   3                      //      Temp_f = CS5460_ReadReg( addIRMS );     // ×ª»»Îª¸¡µãÊý
 923   3                      //      Temp_f *= conCurrent_Cof;               // ×ª»»ÎªÐ¡Êý ³ËÉÏÏµÊý
 924   3                      //      Temp_l  = Temp_f;                       // ×ª»»Îª³¤ÕûÐÎÊý
 925   3                              // ²ð·Öµ½ÏàÓ¦Í¨µÀµÄÏàÓ¦Ïî»º³åÇø
 926   3                      //      LongToASCII( &Measure_Buf[CS5460_Channel][1][0], Temp_l, 'I' );
 927   3                              // »ñÈ¡¹¦ÂÊÖµ
 928   3                         Temp_l=CS5460_ReadReg(addIRMS);
 929   3                 Temp_l=Temp_l>>8;
 930   3                         Temp_l=Temp_l*conCurrent_sys;
 931   3                         Temp_l=Temp_l>>16;
 932   3                 Measure_Buf[CS5460_Channel][3]=Temp_l;
 933   3                 Measure_Buf[CS5460_Channel][2]=Temp_l>>8;  //µçÁ÷Öµ ´æÈëµ½measure_buf[][]ÖÐ 
 934   3      
 935   3      
 936   3      
 937   3                       //     Temp_l = CS5460_ReadReg( addP );
 938   3                      //      Plus_Flag = 0;
 939   3                      //      if( Temp_l & 0x00800000 ){ 
 940   3                      //              Plus_Flag = 1; 
 941   3                      //              Temp_l &= 0x007FFFFF; 
 942   3                      //      }
 943   3                      //      Temp_f = Temp_l;        // ×ª»»Îª¸¡µãÊý
 944   3                      //      Temp_f *= conPower_Cof;         // ×ª»»ÎªÐ¡Êý ³ËÉÏÏµÊý
 945   3                      //      Temp_l  = Temp_f;                       // ×ª»»Îª³¤ÕûÐÎÊý
 946   3                              // ²ð·Öµ½ÏàÓ¦Í¨µÀµÄÏàÓ¦Ïî»º³åÇø
 947   3                      //      LongToASCII( &Measure_Buf[CS5460_Channel][2][0], Temp_l, 'P' );
 948   3                      //      if( Plus_Flag ) { Measure_Buf[CS5460_Channel][2][0] = '-'; }
 949   3                              // Çå³ý±êÖ¾
 950   3                              CS5460_WriteReg( addStatus, CS5460_Flag0, CS5460_Flag1, CS5460_Flag2 );
 951   3                              // ÇÐ»»Í¨µÀ
 952   3                              CS5460_Channel++;
 953   3                              //if( CS5460_Channel >= 6 ){ CS5460_Channel = 0; }
 954   3                              if( CS5460_Channel >= 8 ){ CS5460_Channel = 0; }
 955   3                              //CS5460_Channel = 1;
 956   3                              Output_Channel = con_ChannelChange[ CS5460_Channel ];
 957   3                              CD4051_EN0 = 1; 
 958   3                              CD4051_EN1 = 1;
 959   3                              if( ( Output_Channel & 0x01 ) == 0x01 ){ CD4051_A = 1; }
 960   3                              else                                   { CD4051_A = 0; }
 961   3                              if( ( Output_Channel & 0x02 ) == 0x02 ){ CD4051_B = 1; }
 962   3                              else                                   { CD4051_B = 0; }
 963   3                              if( ( Output_Channel & 0x04 ) == 0x04 ){ CD4051_C = 1; }
 964   3                              else                                   { CD4051_C = 0; }
 965   3                              CD4051_EN0 = 0; 
 966   3                              CD4051_EN1 = 0;
 967   3                      }
 968   2                      
 969   2              }
 970   1      
 971   1              // 1sµ½
 972   1              if( ( State_Timer % 100 ) == 0 ){ State_Timer = 0;
 973   2                      SystemLED_Flag = ~SystemLED_Flag;
 974   2              }
 975   1      
 976   1      }  
 977          
 978          
 979          
 980          
 981          
C51 COMPILER V9.00   C_MAIN                                                                04/28/2014 09:24:44 PAGE 17  

 982          /*=======================================================================
 983          º¯ÊýÃû³Æ£ºWait_DRDY
 984          º¯Êý¹¦ÄÜ: 
 985          ÊäÈë²ÎÊý£ºÎÞ
 986          Êä³ö²ÎÊý£ºÎÞ
 987          ·µ »Ø Öµ£ºÎÞ
 988          ÆäËüËµÃ÷£º1¡¢Ð£×¼ÆÚ¼äÖ¸Ê¾µÆ³£ÁÁ
 989                            2¡¢Ð£×¼Íê³ÉºóÖ¸Ê¾µÆÉÁ3´Î,²¢ÉÏ´«Ð£×¼Íê³ÉÏûÏ¢
 990                            3¡¢Ð£×¼ºóµÄÏµÊý´æÈëE2PROMÖÐ
 991          =======================================================================*/
 992          void Wait_DRDY( void ){
 993   1              CS5460_Status = CS5460_ReadReg( addStatus );
 994   1              CS5460_Flag2  = CS5460_Status;   
 995   1              CS5460_Flag1  = ( CS5460_Status >> 8 );
 996   1              CS5460_Flag0  = ( CS5460_Status >> 16 );
 997   1      }
 998          /*                                                       
 999          unsigned char code con_CabTab[] = { (0xC1 | 0x01), (0xC1 | 0x05), (0xC1 | 0x02), (0xC1 | 0x06),
1000                                                                    
1001                                                                                  (0xD0 | 0x01), (0xD0 | 0x05), (0xD0 | 0x02), (0xD0 | 0x06)
1002                                                                            };
1003          
1004           */
1005          unsigned char code con_CabTab[] = { (0xC8 | 0x01), (0xC8 | 0x05), (0xC8 | 0x02), (0xC8 | 0x06),
1006                                                                    
1007                                                                                  (0xD0 | 0x01), (0xD0 | 0x05), (0xD0 | 0x02), (0xD0 | 0x06)
1008                                                                            };
1009          
1010          
1011          /*=======================================================================
1012          º¯ÊýÃû³Æ£ºSystem_Cab
1013          º¯Êý¹¦ÄÜ£ºÏµÍ³Ð£×¼º¯Êý
1014          ÊäÈë²ÎÊý£ºÎÞ
1015          Êä³ö²ÎÊý£ºÎÞ
1016          ·µ »Ø Öµ£ºÎÞ
1017          ÆäËüËµÃ÷£º1¡¢Ð£×¼ÆÚ¼äÖ¸Ê¾µÆ³£ÁÁ
1018                            2¡¢Ð£×¼Íê³ÉºóÖ¸Ê¾µÆÉÁ3´Î,²¢ÉÏ´«Ð£×¼Íê³ÉÏûÏ¢
1019                            3¡¢Ð£×¼ºóµÄÏµÊý´æÈëE2PROMÖÐ
1020          =======================================================================*/
1021          /*
1022          void System_Cab( void ){
1023          
1024                  SystemLED_Flag = con_LEDOn;
1025          
1026                  // Çå±ê¼Ç
1027                  CS5460_WriteReg( addStatus, 0xFF, 0xFF, 0xFF );
1028                  // 1¡¢·¢ËÍPower_UpÃüÁî
1029                  CS5460_SendCmd( cmdPowerUpHalt );
1030                  // Çå±ê¼Ç
1031                  CS5460_WriteReg( addStatus, 0xFF, 0xFF, 0xFF ); 
1032          
1033                  CS5460_SendCmd( con_CabTab[ CS5460_CabNum ]  );
1034                  DRDY_Flag = 0;
1035                  while( DRDY_Flag == 0 ){
1036                     Wait_DRDY();
1037                  }
1038          
1039                  CS5460_WriteReg( addStatus, CS5460_Flag0, CS5460_Flag1, CS5460_Flag2 );
1040          
1041                  Save_Parameter( );
1042                  CS5460_SendCmd( cmdStartCVTCtinu );  // ·¢ËÍÁ¬ÐøÆô¶¯×ª»»ÃüÁî
1043          
C51 COMPILER V9.00   C_MAIN                                                                04/28/2014 09:24:44 PAGE 18  

1044                  UART0_TranState = 'C';
1045                  // Ï¨ÃðLED
1046                  SystemLED_Flag = con_LEDOff;
1047                  // ÇÐ»»µ½ÏµÍ³¿ÕÏÐ×´Ì¬
1048                  System_State = conSysIDLEState; State_Timer = 0;
1049          
1050          }
1051          
1052           */
1053          
1054          /*=======================================================================
1055          º¯ÊýÃû³Æ£ºSystem_Cab
1056          º¯Êý¹¦ÄÜ£ºÏµÍ³Ð£×¼º¯Êý
1057          ÊäÈë²ÎÊý£ºÎÞ
1058          Êä³ö²ÎÊý£ºÎÞ
1059          ·µ »Ø Öµ£ºÎÞ
1060          ÆäËüËµÃ÷£º1¡¢Ð£×¼ÆÚ¼äÖ¸Ê¾µÆ³£ÁÁ
1061                            2¡¢Ð£×¼Íê³ÉºóÖ¸Ê¾µÆÉÁ3´Î,²¢ÉÏ´«Ð£×¼Íê³ÉÏûÏ¢
1062                            3¡¢Ð£×¼ºóµÄÏµÊý´æÈëE2PROMÖÐ
1063          =======================================================================*/
1064          void System_Cab( void ){
1065   1      
1066   1        //    SystemLED_Flag = con_LEDOn;
1067   1          System_LED  =       con_LEDOn;
1068   1      
1069   1              CS5460_Channel=0;  //tong dap1 
1070   1              CD4051_A=1;
1071   1              CD4051_B=0;
1072   1              CD4051_C=0;        // tong dao 1
1073   1              _nop_();
1074   1              _nop_();
1075   1              _nop_();
1076   1              _nop_();
1077   1      
1078   1              CD4051_EN0=0;
1079   1              CD4051_EN1=0; //4051  enable 
1080   1      
1081   1              _nop_();
1082   1              _nop_();
1083   1              _nop_();
1084   1              _nop_();
1085   1      
1086   1              _nop_();
1087   1              _nop_();
1088   1              _nop_();
1089   1              _nop_();
1090   1              delaynus (200) ;
1091   1      
1092   1              // Çå±ê¼Ç
1093   1              CS5460_WriteReg( addStatus, 0xFF, 0xFF, 0xFF );
1094   1      
1095   1              _nop_();
1096   1              _nop_();
1097   1              _nop_();
1098   1              _nop_();
1099   1                      delaynus (200) ;
1100   1              // 1¡¢·¢ËÍPower_UpÃüÁî
1101   1              CS5460_SendCmd( cmdPowerUpHalt );
1102   1      
1103   1              _nop_();
1104   1              _nop_();
1105   1              _nop_();
C51 COMPILER V9.00   C_MAIN                                                                04/28/2014 09:24:44 PAGE 19  

1106   1              _nop_();
1107   1              // Çå±ê¼Ç
1108   1              CS5460_WriteReg( addStatus, 0xFF, 0xFF, 0xFF ); 
1109   1              _nop_();
1110   1              _nop_();
1111   1              _nop_();
1112   1              _nop_();
1113   1                      delaynus (200) ;
1114   1      
1115   1              
1116   1              
1117   1              CS5460_SendCmd( con_CabTab[ CS5460_CabNum ]  );           
1118   1          
1119   1              DRDY_Flag = 0;
1120   1              while( DRDY_Flag == 0 ){
1121   2                 Wait_DRDY();
1122   2                 WDT_CONTR = 0x38;    
1123   2              }
1124   1      
1125   1              CS5460_WriteReg( addStatus, CS5460_Flag0, CS5460_Flag1, CS5460_Flag2 );
1126   1      
1127   1      
1128   1      
1129   1           
1130   1              Save_Parameter( );
1131   1              CS5460_SendCmd( cmdStartCVTCtinu );  // ·¢ËÍÁ¬ÐøÆô¶¯×ª»»ÃüÁî
1132   1      
1133   1              UART0_TranState = 'C';
1134   1              // Ï¨ÃðLED
1135   1              SystemLED_Flag = con_LEDOff;
1136   1              // ÇÐ»»µ½ÏµÍ³¿ÕÏÐ×´Ì¬
1137   1              System_State = conSysIDLEState; State_Timer = 0;
1138   1              
1139   1      
1140   1      }
1141          
1142          
1143          
1144           /*======================================================
1145              ×Ô±ê¶¨
1146             °Ñ²É³öµÄÊý ÓÃ220v    µÄ±ê×¼      x=22000 *65536 /       Âë
1147             ¼ÆËãºóµÄÊý   ÓÒÒÆÁ½¸ö×Ö½Ú            È»ºó´æÈË200 ¿ªÊ¼µÄµÚ¶þÉÈÇø
1148             212  ´æÈë01 
1149            =====================================================*/
1150          
1151          
1152           void vself_cab(void)
1153              {unsigned  char templ ,temph;
1154   1               unsigned  int  temp_sys;
1155   1               unsigned  int    ee_address;
1156   1                   
1157   1                   System_LED  =      con_LEDOn;
1158   1                       ee_address=0x200;
1159   1               Sector_Erase(ee_address);
1160   1      
1161   1      /*               for(i=0; i<=5; i++)
1162   1                 {
1163   1                                temp_sys= 0x55f00000 / measure_ma[i][0] ;     //22000*65536
1164   1                            v_sys[i]=temp_sys;          //´æÈËµçÑ¹ÏµÊý
1165   1                                templ=temp_sys;
1166   1                                temph=temp_sys>>8;
1167   1                    ISP_Byte_Write(ee_address++ ,temph);//
C51 COMPILER V9.00   C_MAIN                                                                04/28/2014 09:24:44 PAGE 20  

1168   1                                ISP_Byte_Write(ee_address++ ,templ);  //
1169   1                     }
1170   1      */      
1171   1               
1172   1                                temp_sys= 0x55f00000 / measure_ma[0][0] ;     //22000*65536
1173   1                            v_sys=temp_sys;     //´æÈËµçÑ¹ÏµÊý
1174   1                                templ=temp_sys;
1175   1                                temph=temp_sys>>8;
1176   1                    ISP_Byte_Write(ee_address++ ,temph);  //v_sys µÄ ¸ß8Î»´æÈë 200hÖÐ
1177   1                                ISP_Byte_Write(ee_address++ ,templ);  // v_sys µÄµÍ8Î»´æÈë 201hÖÐ
1178   1                     
1179   1                        ISP_Byte_Write(0x212 ,0x01);   //eeprom   °Ñ01h ´æÈëµ½ 0x212ÖÐ 
1180   1      
1181   1                
1182   1              }
1183          
1184          
1185           /*================================
1186            ÏÈ¶Á212µØÖ·µÄÊý¾ÝÊÇ·ñ01
1187            ÊÇ £¬¶ÁÈëÊý¾Ý·ÅÈë¶ÔÓ¦µÄÏµÊýÖÐ
1188          
1189          
1190          
1191           ==================================*/
1192          
1193           void read_vsys(void)
1194             { unsigned  char i,  temp_data ,temp_datah ,temp_datal;
1195   1           unsigned int  temp_w;
1196   1           unsigned int ee_address;
1197   1               ee_address=0x200;
1198   1           temp_data= ISP_Byte_Read( 0x212 );//ÅÐ212ÊÇ·ñÊÇ01h
1199   1               if(temp_data==0x01)
1200   1                 /* {for(i=0;i<=5 ;i++)
1201   1                         { temp_datah = ISP_Byte_Read(ee_address++);
1202   1                           temp_datal=  ISP_Byte_Read(ee_address++);
1203   1                               temp_w=temp_datah;
1204   1                               temp_w<<=8;
1205   1                               temp_w+=temp_datal;
1206   1                               v_sys[i]=temp_w;       //´æÈëÏµÊýµ½ÄÚ´æÊý×éÖÐ
1207   1                         }
1208   1                      */
1209   1                 {     temp_datah = ISP_Byte_Read(ee_address++);
1210   2                           temp_datal=  ISP_Byte_Read(ee_address++); //´Óflash¶ÁÈËµçÑ¹ÏµÊýµ½v_sysÖÐ
1211   2                               temp_w=temp_datah;
1212   2                               temp_w<<=8;
1213   2                               temp_w+=temp_datal;
1214   2                               v_sys=temp_w;  //´æÈëÏµÊýµ½ÄÚ´æÊý×éÖÐ
1215   2              }
1216   1           
1217   1         }
*** WARNING C280 IN LINE 1194 OF ..\SYSTEM_FUNCTION\C_MAIN.C: 'i': unreferenced local variable
1218          
1219          
1220          /*====================================================================       ===
1221          º¯ÊýÃû³Æ£ºOutput_Port
1222          º¯Êý¹¦ÄÜ£º¶Ë¿ÚË¢ÐÂº¯Êý
1223          ÊäÈë²ÎÊý£ºÎÞ
1224          Êä³ö²ÎÊý£ºÎÞ
1225          ·µ »Ø Öµ£ºÎÞ
1226          ÆäËüËµÃ÷£ºÎÞ
1227          =======================================================================*/
1228          void Output_Port( void ){
C51 COMPILER V9.00   C_MAIN                                                                04/28/2014 09:24:44 PAGE 21  

1229   1      
1230   1              System_LED = SystemLED_Flag;
1231   1      
1232   1      }
1233          
1234          /*=======================================================================
1235          º¯ÊýÃû³Æ£ºmain
1236          º¯Êý¹¦ÄÜ£º
1237          ÊäÈë²ÎÊý£ºÎÞ
1238          Êä³ö²ÎÊý£ºÎÞ
1239          ·µ »Ø Öµ£ºÎÞ
1240          ÆäËüËµÃ÷£ºÎÞ
1241          =======================================================================*/
1242          void main( void ){
1243   1              bit bdata biao_flag=0;
1244   1              Max485_Rece;             // 485½ÓÊÕÊ¹ÄÜ
1245   1              System_LED = con_LEDOn;  // µãÁÁÏµÍ³Ö¸Ê¾µÆ
1246   1              Init_System( );
1247   1      
1248   1              while(1){ 
1249   2                      WDT_CONTR = 0x38;
1250   2                              if((STL==0 ) && (biao_flag==0) )
1251   2                                {     vself_cab( );
1252   3                                  biao_flag=1;
1253   3                                }      
1254   2                      // Ã¿10msÒª×öµÄÊÂÇé
1255   2                      if( Flag_10ms ){ Flag_10ms = 0;         
1256   3                                 WDT_CONTR = 0x38;
1257   3                                              // ×ÜÒª×öµÄÊÂÇé
1258   3                              if( UART0_ReceOKFlag ){ // ´®ÐÐ¿Ú½ÓÊÕºÃ
1259   4                                      UART0_UnPacket( );      // µ÷ÓÃ´®ÐÐ¿Ú½â°üÃüÁî
1260   4                                      UART0_ReceOKFlag = 0; // Çå½ÓÊÕºÃ±ê¼Ç
1261   4                              }
1262   3                              if( UART0_TranState ){ UART0_Packet(); }
1263   3                              // ÏµÍ³×´Ì¬»ú´¦Àí
1264   3                              if( State_Timer < 65530 ) { State_Timer++; }                    
1265   3                              switch( System_State ){
1266   4                                      case conSysPowerOnState: System_PowerOn(); break;
1267   4                                      case conSysIDLEState:    System_IDLE();    break;
1268   4                                      case conSysCabState:     System_Cab();     break;
1269   4                                      default: System_State = conSysPowerOnState; State_Timer = 0;  break;
1270   4                              } // ÏµÍ³×´Ì¬»ú´¦Àí½áÊø
1271   3      
1272   3                              // 10msË¢ÐÂÒ»´ÎÊä³ö¶Ë¿Ú
1273   3                              Output_Port( );
1274   3      
1275   3                      } // 10msÊÂ¼þ´¦Àí½áÊø
1276   2              }
1277   1      
1278   1      }
1279          
1280          
1281          
1282          /*=======================================================================
1283          º¯ÊýÃû³Æ£ºISR_INT0  Íâ²¿ÖÐ¶Ï0µÄÖÐ¶Ï·þÎñ
1284          º¯Êý¹¦ÄÜ£ººìÍâÏßÊäÈë¼ì²â          
1285          ÊäÈë²ÎÊý£ºÎÞ
1286          Êä³ö²ÎÊý£ºÎÞ
1287          ·µ »Ø Öµ£ºÎÞ
1288          ÆäËüËµÃ÷£ºÎÞ
1289          =======================================================================*/
1290          void ISR_INT0( void ) interrupt 0  using 1{
C51 COMPILER V9.00   C_MAIN                                                                04/28/2014 09:24:44 PAGE 22  

1291   1              
1292   1                       
1293   1      }
1294          
1295          /*=======================================================================
1296          º¯ÊýÃû³Æ£ºISR_Timer0  ¶¨Ê±Æ÷T0ÖÐ¶Ï·þÎñ
1297          º¯Êý¹¦ÄÜ£ºÊµÏÖ10ms¶¨Ê±ÖÐ¶Ï          
1298          ÊäÈë²ÎÊý£ºÎÞ
1299          Êä³ö²ÎÊý£ºÎÞ
1300          ·µ »Ø Öµ£ºÎÞ
1301          ÆäËüËµÃ÷£ºÎÞ
1302          =======================================================================*/
1303          void ISR_Timer0( void ) interrupt 1  //using 1
1304          {
1305   1                                
1306   1              TH0   = 0xD5;
1307   1              TL0   = 0x9D;
1308   1      
1309   1              Flag_10ms = 1;
1310   1      
1311   1      } 
1312          
1313          /*=======================================================================
1314          º¯ÊýÃû³Æ£ºISR_INT1  Íâ²¿ÖÐ¶Ï1µÄÖÐ¶Ï·þÎñ
1315          º¯Êý¹¦ÄÜ£º¼üÅÌÊäÈë¼ì²â          
1316          ÊäÈë²ÎÊý£ºÎÞ
1317          Êä³ö²ÎÊý£ºÎÞ
1318          ·µ »Ø Öµ£ºÎÞ
1319          ÆäËüËµÃ÷£ºÎÞ
1320          =======================================================================*/
1321          void ISR_INT1( void ) interrupt 2  //using 1
1322          {
1323   1               
1324   1      }
1325          
1326          /*=======================================================================
1327          º¯ÊýÃû³Æ£ºISR_Timer1  ¶¨Ê±Æ÷T1ÖÐ¶Ï·þÎñ
1328          º¯Êý¹¦ÄÜ£ºÊµÏÖ1ms¶¨Ê±ÖÐ¶Ï          
1329          ÊäÈë²ÎÊý£ºÎÞ
1330          Êä³ö²ÎÊý£ºÎÞ
1331          ·µ »Ø Öµ£ºÎÞ
1332          ÆäËüËµÃ÷£ºÎÞ
1333          =======================================================================*/
1334          void ISR_Timer1( void ) interrupt 3 // using 1
1335          {
1336   1      
1337   1      }
1338          
1339          /*=======================================================================
1340          º¯ÊýÃû³Æ£ºISR_Serial0 ´®ÐÐ¿Ú0ÖÐ¶Ï·þÎñ
1341          º¯Êý¹¦ÄÜ£ºÏµÍ³µ÷ÊÔ      
1342          ÊäÈë²ÎÊý£ºÎÞ
1343          Êä³ö²ÎÊý£ºÎÞ
1344          ·µ »Ø Öµ£ºÎÞ
1345          ÆäËüËµÃ÷£ºÎÞ
1346          =======================================================================*/
1347          
1348          
1349          
1350          
1351          void ISR_UART0( void ) interrupt 4 // using 1
1352          {
C51 COMPILER V9.00   C_MAIN                                                                04/28/2014 09:24:44 PAGE 23  

1353   1          unsigned char Temp_Data;
1354   1      
1355   1              // ½ÓÊÕÖÐ¶Ï
1356   1          if( RI ){  RI = 0;
1357   2                      if( UART0_ReceOKFlag == 0 ){
1358   3                          Temp_Data = SBUF;
1359   3                          if( Temp_Data == 0x4c ){    UART0_ReceCounter = 0; }
1360   3                          UART0_ReceBuf[ UART0_ReceCounter++ ] = Temp_Data;
1361   3                          if( UART0_ReceCounter == con_UART0ReceMaxNum ){
1362   4                              UART0_ReceCounter = 0;
1363   4                              if( (UART0_ReceBuf[1] == 0x57 )&& ((UART0_ReceBuf[3]==0x03) ||(UART0_ReceBuf[3]==0x05) ||(UART0_
             -ReceBuf[3]==0x06))       &&(UART0_ReceBuf[6]==0x0d)){ // °üÍêÕûÐÔÐ£Ñé
1364   5                                              // ±¾»úµØÖ·Ð£Ñé
1365   5                                              if( UART0_ReceBuf[2] == Device_Address ){
1366   6                                                  UART0_ReceOKFlag = 1; // µ÷ÊÔÓÃ,ÔÝ²»×öCRCÐ£Ñé
1367   6                                              }                              
1368   5                                  }
1369   4                          }
1370   3                      }
1371   2              }
1372   1      
1373   1              // ·¢ËÍÖÐ¶Ï
1374   1              if( TI ){ TI = 0; 
1375   2                      if( UART0_TranCounter < UART0_TranMaxNum ){
1376   3                          delaynus(10);
1377   3                              SBUF = UART0_TranBuf[ UART0_TranCounter++ ];                    
1378   3                      }
1379   2                      else{
1380   3                              Max485_Rece;             // 485½ÓÊÕÊ¹ÄÜ
1381   3                      }
1382   2              }
1383   1      
1384   1      }
1385          
1386          
1387          
1388          
1389          
1390          /*
1391          void ISR_UART0( void ) interrupt 4 // using 1
1392          {
1393              unsigned char Temp_Data;
1394          
1395                  // ½ÓÊÕÖÐ¶Ï
1396              if( RI ){  RI = 0;
1397                          if( UART0_ReceOKFlag == 0 ){
1398                              Temp_Data = SBUF;
1399                              if( Temp_Data == '[' ){     UART0_ReceCounter = 0; }
1400                              UART0_ReceBuf[ UART0_ReceCounter++ ] = Temp_Data;
1401                              if( UART0_ReceCounter == con_UART0ReceMaxNum ){
1402                                  UART0_ReceCounter = 0;
1403                                  if( Temp_Data == ']' ){ // °üÍêÕûÐÔÐ£Ñé
1404                                                  // ±¾»úµØÖ·Ð£Ñé
1405                                                  if( UART0_ReceBuf[1] == con_HexCode[Device_Address] ){
1406                                                      UART0_ReceOKFlag = 1; // µ÷ÊÔÓÃ,ÔÝ²»×öCRCÐ£Ñé
1407                                                  }                              
1408                                      }
1409                              }
1410                          }
1411                  }
1412          
1413                  // ·¢ËÍÖÐ¶Ï
C51 COMPILER V9.00   C_MAIN                                                                04/28/2014 09:24:44 PAGE 24  

1414                  if( TI ){ TI = 0; 
1415                          if( UART0_TranCounter < UART0_TranMaxNum ){
1416                                  SBUF = UART0_TranBuf[ UART0_TranCounter++ ];                    
1417                          }
1418                          else{
1419                                  Max485_Rece;             // 485½ÓÊÕÊ¹ÄÜ
1420                          }
1421                  }
1422          
1423          }
1424          
1425          */
1426          
1427          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2475    ----
   CONSTANT SIZE    =     35    ----
   XDATA SIZE       =     83    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     13      32
   IDATA SIZE       =     54    ----
   BIT SIZE         =      3       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
