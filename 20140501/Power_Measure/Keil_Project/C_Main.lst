C51 COMPILER V8.08   C_MAIN                                                                07/29/2010 17:32:25 PAGE 1   


C51 COMPILER V8.08, COMPILATION OF MODULE C_MAIN
OBJECT MODULE PLACED IN .\C_Main.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE ..\System_Function\C_Main.c BROWSE INCDIR(..\Hard_Module;..\System_Function
                    -;..\CPU_Register) DEBUG OBJECTEXTEND PRINT(.\C_Main.lst) OBJECT(.\C_Main.obj)

line level    source

   1          
   2          /*=========================================================
   3                              ¹¦ÂÊ¼Æ       ----ÓÐÏÞ¹«Ë¾
   4          °æ    ±¾£ºV1.0
   5          ¿ª·¢Ê±¼ä£º2010Äê7ÔÂ26ÈÕ
   6          °æÈ¨ËùÓÐ£º2010--2099,ºÓ±±¿Æ¼¼´óÑ§  ÐÅÏ¢¿ÆÑ§Óë¹¤³ÌÏµ  ÃÏÖ¾ÓÀ
   7                                                                        ÊÖ»ú£º13933120973
   8                                                                                     Email£ºKDMZY@163.com
   9            ÎÄ ¼þ Ãû£ºC_Main.c
  10            ×÷    Õß: ÃÏÖ¾ÓÀ
  11            °æ    ±¾: V1.0
  12            Íê³ÉÈÕÆÚ: 2010Äê7ÔÂ29ÈÕ
  13            ÃèÊöÐÅÏ¢: ¹¦ÂÊ¼Æ
  14            ÆäËûËµÃ÷: Ð¾Æ¬ÀàÐÍ£ºSTC12C5604AD  Ö÷Æµ£º11.0592MHz       
  15            ¹¦ÄÜÁÐ±í: 
  16                                  1¡¢ÏµÍ³³õÊ¼»¯
  17                                  2¡¢CS5460Ð¾Æ¬³õÊ¼»¯¼°ÅäÖÃ
  18                                  3¡¢UART0´®ÐÐ¿ÚÊÕ·¢´¦Àí
  19                                  4¡¢16Í¨µÀµÄµçÁ÷ÕæÓÐÐ§Öµ¡¢µçÑ¹ÕæÓÐÐ§ÖµºÍ¹¦ÂÊÖµ²âÁ¿
  20                                  5¡¢LEDÏÔÊ¾¿ØÖÆ
  21                                  6¡¢485ÊÕ·¢¿ØÖÆ
  22            ÀúÊ·¼ÍÂ¼:   
  23                      1¡¢ÈÕ    ÆÚ:
  24                         ×÷    Õß:
  25                         ÐÞ¸ÄÄÚÈÝ:
  26          =========================================================*/
  27          
  28          /*=============Í·ÎÄ¼þÉùÃ÷================================*/
  29          #include "STC12C5620AD_H.h"
  30          
  31          #include "H_STC12C5404ADMdu.H"
  32          #include "H_STCE2PROM.h"
  33          #include "H_Interface.h"
  34          #include "H_CS5460.h"
  35          
  36          /*=======================================================================
  37                                          ÏµÍ³¹«¹²±äÁ¿ÉùÃ÷
  38          =======================================================================*/
  39                            bit Flag_10ms   = 0;          // 10ms±êÖ¾
  40                           // bit Flag_100ms  = 0;        // 100ms±êÖ¾
  41                           // bit Flag_1000ms = 0;        // 1000ms±êÖ¾
  42                           // bit Flag_5s     = 0;      // 5Ãë±êÖ¾
  43          
  44          //unsigned char Counter_10ms   = 0;   // 10ms¼ÆÊýÆ÷
  45          //unsigned char Counter_100ms  = 0;     // 100ms¼ÆÊýÆ÷
  46          //unsigned char Counter_1000ms = 0;     // 1000ms¼ÆÊýÆ÷
  47          
  48          
  49          #define conSysPowerOnState  0x00        // ÏµÍ³¸ÕÉÏµçÊ±µÄ×´Ì¬
  50          #define conSysIDLEState     0x01        // ÏµÍ³¿ÕÏÐ×´Ì¬
  51          #define conSysCabState      0x02    // ÏµÍ³Ð£×¼×´Ì¬
  52          
  53          unsigned char System_State   = conSysPowerOnState;
  54          unsigned  int State_Timer    = 0;
C51 COMPILER V8.08   C_MAIN                                                                07/29/2010 17:32:25 PAGE 2   

  55                            bit SystemLED_Flag;
  56          
  57          /*=======================================================================
  58          Êý¾ÝÉÏ´«¸ñÊ½ÈçÏÂ£º
  59          [@ZZ$D#YY-XX:0000.00V|0000.00A|0000.00W|0000.00Q|0000.00@|0000.00H|0000.00S|CRC]
  60          1¡¢ÒÔ'['¿ªÊ¼£¬ÒÔ']'½áÊø
  61          2¡¢@´Ó»úµØÖ·
  62          3¡¢#Í¨µÀºÅ
  63          4¡¢²ÎÊýÐòºÅ£º00£ºµçÑ¹
  64                       01£ºµçÁ÷
  65                                   02£º¹¦ÂÊ
  66                                   03£º¹¦ÂÊÒòÊý
  67                                   04£ºÏàÎ»²î½Ç
  68                                   05£ºÆµÂÊ
  69                                   06£ºÖÜÆÚ
  70                                   07£ºÔ¤Áô
  71                                   08£ºÔ¤Áô
  72                                   09£ºÔ¤Áô
  73                                   FF£º±íÊ¾ÒÔÉÏÈ«²¿²ÎÊý
  74                  Ã¿¸ö²ÎÊý²ÉÓÃ¹Ì¶¨¸ñÊ½£¬¼´0000.00µ¥Î»£¬¸÷¸ö²ÎÊýÒÔ¡®|¡¯¸ô¿ª
  75                  ¸÷¸ö²ÎÊýµÄ¾ßÌå·¶Î§ÈçÏÂ£º
  76                          µç    Ñ¹£º0¡«45.0V
  77                          µç    Á÷£º0¡«5A
  78                          ¹¦ ÂÊ Öµ£º0¡«2250W
  79                          ¹¦ÂÊÒòÊý£º0¡«1.00
  80                          ÏàÎ»²î½Ç£º0¡«360.00
  81                          Æµ    ÂÊ£º0¡«100Hz
  82                          ÖÜ    ÆÚ£º0¡«00000S
  83          5¡¢³ý[]·ûºÅÒÔÍâµÄÆäËûÊý¾ÝµÄºÍÈ»ºó×ª»»ÎªASCIIÂë£¬·¶Î§´Ó000~256
  84          
  85          [@ZZ$R# R-XX:FFFFFF|CRC]:±íÊ¾ÉÏ´«µÄZZµ¥Æ¬»úµÄXXµØÖ·¼Ä´æÆ÷µÄÄÚÈÝ
  86          [@ZZ$S#  ACK       |CRC]£º
  87          [@ZZ$S# nACK       |CRC]£º
  88          =======================================================================*/
  89          /*=======================================================================
  90          Êý¾ÝÏÂ´«¸ñÊ½ÈçÏÂ£º
  91          0123456789ABCDEF
  92          [@ZZ$D#YY-XX       CRC]£º±íÊ¾¶ÁÈ¡ZZµØÖ·µ¥Æ¬»úµÄYYÍ¨µÀµÄµÚXXÏî²ÎÊý
  93                                                   µ±XX=FFÊ±±íÊ¾£¬Ò»´Î»ñÈ¡ÆäYYÍ¨µÀµÄËùÓÐ²ÎÊý
  94          [@ZZ$R#R-XX        CRC]£º±íÊ¾¶ÁÈ¡FµØÖ·µ¥Æ¬»úµÄXXµØÖ·¼Ä´æÆ÷µÄÄÚÈÝ
  95          
  96          [@ZZ$W#R-XX|FFFFFF CRC]£º±íÊ¾Ð´ZZµØÖ·µ¥Æ¬»úµÄXX¼Ä´æÆ÷µÄÄÚÈÝ
  97          
  98          [@ZZ$C# 0-VIDC      CRC]£º±íÊ¾Ð´ZZµØÖ·µ¥Æ¬»úµÄµçÑ¹µçÁ÷½øÐÐDCÐ£×¼
  99          [@ZZ$C# 1-VIAC      CRC]£º±íÊ¾Ð´ZZµØÖ·µ¥Æ¬»úµÄµçÑ¹µçÁ÷½øÐÐACÐ£×¼
 100          [@ZZ$C# 2-VIGain    CRC]£º±íÊ¾Ð´ZZµØÖ·µ¥Æ¬»úµÄµçÑ¹µçÁ÷½øÐÐÔöÒæÐ£×¼
 101          [@ZZ$C# 3-VIOffset  CRC]£º±íÊ¾Ð´ZZµØÖ·µ¥Æ¬»úµÄµçÑ¹µçÁ÷½øÐÐÆ«ÖÃÐ£×¼
 102          
 103          [@ZZ$S#T-Cnn       CRC]£º±íÊ¾Ð´ZZµØÖ·µ¥Æ¬»úµÄÊý¾Ý×Ô¶¯ÉÏ´«¹¦ÄÜµÄÉèÖÃ
 104                                   nn±íÊ¾Ê±¼ä¼ä¸ôµ¥Î»Ãë
 105                                                   nn=00Ê±±íÊ¾½ûÖ¹×Ô¶¯Á¬ÐøÉÏ´«¹¦ÄÜ
 106          [@ZZ$S#S-4800,8,1,0CRC]£º´®ÐÐ¿Ú²¨ÌØÂÊÉèÖÃ
 107          [@ZZ$S#A-XX        CRC]£ºÉèÖÃZZµ¥Æ¬»úµÄÍ¨Ñ¶µØÖ·ÎªXX
 108          =======================================================================*/
 109          unsigned char idata Device_Address;    // ±¾»úµØÖ·
 110          
 111          #define con_UART0TranMaxNum   28
 112          unsigned char idata UART0_TranBuf[con_UART0TranMaxNum]; //  = { "[ 0000.00V|0000.00A|0000.00W|0000.00Q|000
             -0.00@|0000.00H|0000.00S|]" }; // ´®ÐÐ¿Ú0µÄ·¢ËÍ»º³åÇø
 113          unsigned char idata UART0_TranMaxNum;
 114          unsigned char idata UART0_TranCounter;          // ´®ÐÐ¿Ú0µÄ·¢ËÍ¼ÆÊýÆ÷
 115          
C51 COMPILER V8.08   C_MAIN                                                                07/29/2010 17:32:25 PAGE 3   

 116          #define con_UART0ReceMaxNum        6
 117          unsigned char  data UART0_ReceBuf[con_UART0ReceMaxNum];                 // ´®ÐÐ¿Ú0½ÓÊÕ»º³åÇø
 118          unsigned char idata UART0_ReceCounter;          // ´®ÐÐ¿Ú0µÄ½ÓÊÕ¼ÆÊýÆ÷
 119                            bit       UART0_ReceOKFlag = 0;       // ´®ÐÐ¿Ú0µÄ½ÓÊÕºÃ±êÖ¾
 120          unsigned char idata UART0_TranState;        // ´®ÐÐ¿ÚÉÏ´«×´Ì¬×Ö
 121          unsigned char idata UART0_TranChannel;      // ÒªÉÏ´«µÄÍ¨µÀºÅ
 122          
 123          unsigned char code con_HexCode[]  = { "0123456789ABCDEF" }; 
 124          unsigned char idata CS5460_Channel = 0;
 125          
 126          unsigned char xdata Measure_Buf[8][3][8] = {    // Êý¾Ý½á¹û»º³åÇø
 127                                                                                                  // 0Í¨µÀ
 128                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 129                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 130                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0',
 131                                                                                                  // 1Í¨µÀ 
 132                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 133                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 134                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 135                                                                                                  // 2Í¨µÀ
 136                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 137                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 138                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 139                                                                                                  // 3Í¨µÀ
 140                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 141                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 142                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0',
 143                                                                                                  // 4Í¨µÀ 
 144                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 145                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 146                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 147                                                                                                  // 5Í¨µÀ
 148                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 149                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 150                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 151                                                                                                  // 6Í¨µÀ
 152                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 153                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 154                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 155                                                                                                  // 7Í¨µÀ
 156                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 157                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 158                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0'
 159                                                                                          };
 160                                                                                          /*
 161                                                                                                  // 8Í¨µÀ
 162                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 163                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 164                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 165                                                                                                  // 9Í¨µÀ
 166                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 167                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 168                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 169                                                                                                  // 10Í¨µÀ
 170                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 171                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 172                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 173                                                                                                  // 11Í¨µÀ
 174                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 175                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 176                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 177                                                                                                  // 12Í¨µÀ
C51 COMPILER V8.08   C_MAIN                                                                07/29/2010 17:32:25 PAGE 4   

 178                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 179                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 180                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 181                                                                                                  // 13Í¨µÀ
 182                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 183                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 184                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 185                                                                                                  // 14Í¨µÀ
 186                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 187                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 188                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 189                                                                                                  // 15Í¨µÀ
 190                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 191                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0', 
 192                                                                                                  ' ', '0', '0', '0', '0', '.', '0', '0'
 193                                                                                             };
 194                                                                                             */
 195          
 196                          float code conVoltage_Cof = (25000.0 * 5.0 / 16777216.0);
 197                          float code conCurrent_Cof = (25000.0 * 5.0 / 16777216.0);
 198                          float code   conPower_Cof = (250.0*250.0 / 8388608.0);
 199          
 200          unsigned char xdata Parameter_Buf[ 6 * 3 + 1 ]; // ²ÎÊý»º³åÇø
 201          
 202          unsigned char idata Read_State = 0;
 203          
 204          /*=======================================================================
 205                                  CS5460±êÖ¾Î»´¦Àí
 206          =======================================================================*/
 207          unsigned char bdata CS5460_Flag0;
 208          sbit DRDY_Flag = CS5460_Flag0^7;   // Êý¾ÝÓÐÐ§±êÖ¾ ÔÚÁ¬Ðø»òµ¥´Î×ª»»Ä£Ê½ÏÂ±íÃ÷¼ÆËã½á¹ûÒÑ¾­¾ÍÐ÷£¬ÔÚÐ£×¼Ä£Ê½Ï
             -Â±íÊ¾Ð£×¼Êý¾ÝÒÑ¾­Ð´Èëµ½ÏàÓ¦µÄ¼Ä´æÆ÷
 209          sbit EOUT_Flag = CS5460_Flag0^6; 
 210          sbit EDIR_Flag = CS5460_Flag0^5; 
 211          sbit CRDY_Flag = CS5460_Flag0^4; 
 212          sbit MATH_Flag = CS5460_Flag0^3; 
 213          //sbit RES_Flag  = CS5460_Flag0^2; 
 214          sbit IOR_Flag  = CS5460_Flag0^1; 
 215          sbit VOR_Flag  = CS5460_Flag0^0; 
 216          
 217          unsigned char bdata CS5460_Flag1;
 218          sbit PWOR_Flag = CS5460_Flag1^7; 
 219          sbit IROR_Flag = CS5460_Flag1^6; 
 220          sbit VROR_Flag = CS5460_Flag1^5; 
 221          sbit EOR_Flag  = CS5460_Flag1^4; 
 222          sbit EOOR_Flag = CS5460_Flag1^3; 
 223          //sbit RES_Flag  = CS5460_Flag1^2; 
 224          sbit ID3_Flag  = CS5460_Flag1^1; 
 225          sbit ID2_Flag  = CS5460_Flag1^0;
 226          
 227          unsigned char bdata CS5460_Flag2;
 228          sbit ID1_Flag = CS5460_Flag2^7; 
 229          sbit ID0_Flag = CS5460_Flag2^6; 
 230          sbit WDT_Flag = CS5460_Flag2^5; 
 231          sbit VOD_Flag = CS5460_Flag2^4; 
 232          sbit IOD_Flag = CS5460_Flag2^3; 
 233          sbit LSD_Flag = CS5460_Flag2^2; 
 234          //sbit 0_Flag   = CS5460_Flag2^1; 
 235          sbit nIC_Flag = CS5460_Flag2^0;
 236          
 237          long idata CS5460_Status;  // CS5460µÄ×´Ì¬×Ö
 238          
C51 COMPILER V8.08   C_MAIN                                                                07/29/2010 17:32:25 PAGE 5   

 239          unsigned char idata CS5460_CabNum;  // CS5460CÒªÐ£×¼µÄÏî
 240                                                                                          // 0  1  2  3  4   5
 241          unsigned char code con_ChannelChange[] = { 1, 4, 5, 7, 3 , 6 };
 242          unsigned char idata Output_Channel;
 243          
 244          /*=======================================================================
 245          º¯ÊýÃû³Æ£ºstrTostr
 246          º¯Êý¹¦ÄÜ: ×Ö·û´®´«ËÍº¯Êý
 247          ÊäÈë²ÎÊý£º
 248          Êä³ö²ÎÊý£ºÎÞ
 249          ·µ »Ø Öµ£ºÎÞ
 250          ÆäËüËµÃ÷£º
 251          =======================================================================*/
 252          void strTostr( unsigned char *srcP, unsigned char *dstP, unsigned char Number ){
 253   1      
 254   1              unsigned char i;
 255   1      
 256   1              for( i = 0; i < Number; i++ ){ *srcP++ = *dstP++; }
 257   1      
 258   1      }
 259          
 260          /*=======================================================================
 261          º¯ÊýÃû³Æ£ºHexASCIIToBin
 262          º¯Êý¹¦ÄÜ£º
 263          ÊäÈë²ÎÊý£º
 264          Êä³ö²ÎÊý£ºÎÞ
 265          ·µ »Ø Öµ£ºÎÞ
 266          ÆäËüËµÃ÷£º
 267          =======================================================================*/
 268          unsigned char HexASCIIToBin( unsigned char CVT_Data ){
 269   1      
 270   1              if( CVT_Data >= '0' && CVT_Data <= '9' ){ return ( CVT_Data - '0'); }
 271   1              else                                    { return ( CVT_Data - 'A' + 10 ); }
 272   1      
 273   1      }
 274          
 275          /*=======================================================================
 276          º¯ÊýÃû³Æ£ºLongToASCII
 277          º¯Êý¹¦ÄÜ£ºÕûÐÎÊý×ª»»ÎªASCII
 278          ÊäÈë²ÎÊý£º
 279          Êä³ö²ÎÊý£ºÎÞ
 280          ·µ »Ø Öµ£ºÎÞ
 281          ÆäËüËµÃ÷£º
 282          =======================================================================*/
 283          void LongToASCII( unsigned char *p, unsigned long CVT_Data, unsigned char Type_Flag ){
 284   1      
 285   1              *p++ = ' ';
 286   1              *p++ = con_HexCode[ CVT_Data / 100000 ];
 287   1              *p++ = con_HexCode[ CVT_Data % 100000 / 10000 ];
 288   1              if( Type_Flag == 'I' ){ *p++ = '.'; }
 289   1              *p++ = con_HexCode[ CVT_Data % 10000 / 1000 ];
 290   1              *p++ = con_HexCode[ CVT_Data % 1000 / 100 ];
 291   1              if( Type_Flag == 'V' || Type_Flag == 'P' ){ *p++ = '.'; }
 292   1              *p++ = con_HexCode[ CVT_Data % 100 / 10 ];
 293   1              *p++ = con_HexCode[ CVT_Data % 10 ];
 294   1      
 295   1      }
 296          
 297          /*=======================================================================
 298          º¯ÊýÃû³Æ£ºUART0_UnPacket
 299          º¯Êý¹¦ÄÜ£º´®ÐÐ¿Ú½â°üº¯Êý
 300          ÊäÈë²ÎÊý£ºÎÞ
C51 COMPILER V8.08   C_MAIN                                                                07/29/2010 17:32:25 PAGE 6   

 301          Êä³ö²ÎÊý£ºÎÞ
 302          ·µ »Ø Öµ£ºÎÞ
 303          ÆäËüËµÃ÷£º
 304          =======================================================================*/
 305          /*=======================================================================
 306          Êý¾ÝÏÂ´«¸ñÊ½ÈçÏÂ£º
 307          0123456789ABCDEF0123456
 308          [@0F$D#01-00        CR]£º±íÊ¾¶ÁÈ¡ZZµØÖ·µ¥Æ¬»úµÄYYÍ¨µÀµÄµÚXXÏî²ÎÊý
 309                                                   µ±XX=FFÊ±±íÊ¾£¬Ò»´Î»ñÈ¡ÆäYYÍ¨µÀµÄËùÓÐ²ÎÊý
 310          [@0F$R# R-0C        CR]£º±íÊ¾¶ÁÈ¡FµØÖ·µ¥Æ¬»úµÄXXµØÖ·¼Ä´æÆ÷µÄÄÚÈÝ
 311          
 312          [@ZZ$W# R-XX|FFFFFF CR]£º±íÊ¾Ð´ZZµØÖ·µ¥Æ¬»úµÄXX¼Ä´æÆ÷µÄÄÚÈÝ
 313          
 314          [@0F$C# 0-IDCOffset CR]£º±íÊ¾Ð´ZZµØÖ·µ¥Æ¬»úµÄµçÑ¹µçÁ÷½øÐÐDCÐ£×¼
 315          [@0F$C# 1-IACOffset CR]£º±íÊ¾Ð´ZZµØÖ·µ¥Æ¬»úµÄµçÑ¹µçÁ÷½øÐÐACÐ£×¼
 316          [@0F$C# 2-IDCGain   CR]£º±íÊ¾Ð´ZZµØÖ·µ¥Æ¬»úµÄµçÑ¹µçÁ÷½øÐÐÔöÒæÐ£×¼
 317          [@0F$C# 3-IACGain   CR]£º±íÊ¾Ð´ZZµØÖ·µ¥Æ¬»úµÄµçÑ¹µçÁ÷½øÐÐÆ«ÖÃÐ£×¼
 318          [@0F$C# 4-VDCOffset CR]£º±íÊ¾Ð´ZZµØÖ·µ¥Æ¬»úµÄµçÑ¹µçÁ÷½øÐÐDCÐ£×¼
 319          [@0F$C# 5-VACOffset CR]£º±íÊ¾Ð´ZZµØÖ·µ¥Æ¬»úµÄµçÑ¹µçÁ÷½øÐÐACÐ£×¼
 320          [@0F$C# 6-VDCGain   CR]£º±íÊ¾Ð´ZZµØÖ·µ¥Æ¬»úµÄµçÑ¹µçÁ÷½øÐÐÔöÒæÐ£×¼
 321          [@0F$C# 7-VACGain   CR]£º±íÊ¾Ð´ZZµØÖ·µ¥Æ¬»úµÄµçÑ¹µçÁ÷½øÐÐÆ«ÖÃÐ£×¼
 322          
 323          [@ZZ$S# T-Cnn       CR]£º±íÊ¾Ð´ZZµØÖ·µ¥Æ¬»úµÄÊý¾Ý×Ô¶¯ÉÏ´«¹¦ÄÜµÄÉèÖÃ
 324                                   nn±íÊ¾Ê±¼ä¼ä¸ôµ¥Î»Ãë
 325                                                   nn=00Ê±±íÊ¾½ûÖ¹×Ô¶¯Á¬ÐøÉÏ´«¹¦ÄÜ
 326          [@ZZ$S# S-4800,8,1,0CR]£º´®ÐÐ¿Ú²¨ÌØÂÊÉèÖÃ
 327          [@ZZ$S# A-XX        CR]£ºÉèÖÃZZµ¥Æ¬»úµÄÍ¨Ñ¶µØÖ·ÎªXX
 328          [FDF]
 329          [FCX]
 330          01234
 331          =======================================================================*/
 332          void UART0_UnPacket( void ){    
 333   1      
 334   1              switch( UART0_ReceBuf[2] ){
 335   2                      case 'D': // ÒªÊý¾ÝµÄÃüÁî
 336   2                                      UART0_TranChannel   = HexASCIIToBin( UART0_ReceBuf[3] );
 337   2                                      if( UART0_TranChannel < 6 ){
 338   3                                          UART0_TranState = 'D';
 339   3                                      }                                
 340   2                                      break;
 341   2                      case 'C': 
 342   2                                      CS5460_CabNum = HexASCIIToBin( UART0_ReceBuf[3] );
 343   2                                      UART0_TranState = 'A'; // »Ø¸´ÕýÈ·Ó¦´ðÃüÁî
 344   2                                      System_State = conSysCabState; State_Timer = 0;  // ÏµÍ³½øÈëÐ£×¼×´Ì¬ Ð£×¼Íê³Éºó·¢ËÍÐ£×¼Íê³ÉÃüÁî
 345   2                                      break;
 346   2                      default: UART0_TranState = 'Z'; break;
 347   2      
 348   2              }
 349   1      
 350   1      }
 351          
 352          /*=======================================================================
 353          º¯ÊýÃû³Æ£ºUART0_Packet
 354          º¯Êý¹¦ÄÜ£º´¦Àí´®ÐÐ¿ÚÒª·¢ËÍµÄÊý¾Ý°ü ²¢×Ô¶¯Æô¶¯·¢ËÍ
 355          ÊäÈë²ÎÊý£º
 356          Êä³ö²ÎÊý£ºÎÞ
 357          ·µ »Ø Öµ£ºÎÞ
 358          ÆäËüËµÃ÷£º
 359          =======================================================================*/
 360          void UART0_Packet( void ){
 361   1      
 362   1              UART0_TranBuf[0] = '[';                                   // ·ÅÈëÆðÊ¼×Ö·û
C51 COMPILER V8.08   C_MAIN                                                                07/29/2010 17:32:25 PAGE 7   

 363   1              UART0_TranBuf[1] = Device_Address;  // ·ÅÈëµØÖ·
 364   1              // ÉÏ´«Êý¾Ý´ò°ü¹ý³Ì
 365   1              switch( UART0_TranState ){              
 366   2                      case 'D': // ÉÏ´«²É¼¯µ½µÄÊý¾ÝÃüÁî
 367   2                              UART0_TranBuf[ 2] = con_HexCode[ UART0_TranChannel ];
 368   2                                      // È«²¿²ÎÊýÉÏ´«
 369   2                                      strTostr( &UART0_TranBuf[3],  &Measure_Buf[UART0_TranChannel][0], 8 );
 370   2                                      strTostr( &UART0_TranBuf[11], &Measure_Buf[UART0_TranChannel][1], 8 );
 371   2                              //      strTostr( &UART0_TranBuf[19], &Measure_Buf[UART0_TranChannel][2], 8 );
 372   2                                      UART0_TranBuf[19] = ']';
 373   2                                      UART0_TranMaxNum = 20;
 374   2                                      break;   
 375   2                      case 'C':  // ÉÏ´«Ð£×¼Íê³É×´Ì¬ [@ZZ$C# XOK     |CRC]£º
 376   2                                      UART0_TranBuf[ 2] = 'C'; 
 377   2                                      UART0_TranBuf[ 3] = con_HexCode[ CS5460_CabNum ];
 378   2                                      UART0_TranBuf[ 4] = 'O'; 
 379   2                                      UART0_TranBuf[ 5] = 'K'; 
 380   2                                      UART0_TranBuf[ 6] = ']'; 
 381   2                                      UART0_TranMaxNum = 7;
 382   2                                      break;
 383   2                      case 'A':  // ÉÏ´«ÕýÈ·Ó¦´ð×´Ì¬ [@ZZ$S# ACK|CRC]£º
 384   2                                      UART0_TranBuf[ 2] = 'A'; 
 385   2                                      UART0_TranBuf[ 3] = 'C'; 
 386   2                                      UART0_TranBuf[ 4] = 'K'; 
 387   2                                      UART0_TranBuf[ 5] = ']'; 
 388   2                                      UART0_TranMaxNum = 6;
 389   2                                      break;
 390   2                      case 'Z':  // ÉÏ´«ÎÞ·¨Ó¦´ð×´Ì¬ 
 391   2                                      UART0_TranBuf[ 2] = 'n'; 
 392   2                                      UART0_TranBuf[ 3] = 'A'; 
 393   2                                      UART0_TranBuf[ 4] = 'C'; 
 394   2                                      UART0_TranBuf[ 5] = 'K';                                         
 395   2                                      UART0_TranBuf[ 6] = ']';
 396   2                                      UART0_TranMaxNum = 7;
 397   2                                      break;
 398   2                      default: break;
 399   2              }
 400   1          UART0_TranCounter = 0;
 401   1              Max485_Tran;             // 485·¢ËÍÊ¹ÄÜ
 402   1              TI = 1;  // °ÑÊý¾Ý·¢ËÍ³öÈ¥
 403   1              UART0_TranState = 0;
 404   1      
 405   1      }
 406          
 407          
 408          /*=======================================================================
 409          º¯ÊýÃû³Æ£ºGet_Parameter
 410          º¯Êý¹¦ÄÜ£º»ñÈ¡²ÎÊýÖµ, Í¬Ê±ÅäÖÃCS5460
 411          ÊäÈë²ÎÊý£ºÎÞ
 412          Êä³ö²ÎÊý£ºÎÞ
 413          ·µ »Ø Öµ£ºÎÞ
 414          ÆäËüËµÃ÷£º
 415          =======================================================================*/
 416          void Get_Parameter( void ){
 417   1      
 418   1              unsigned char i;
 419   1              unsigned  int Parameter_Address;
 420   1      
 421   1              Parameter_Address = 0;
 422   1      
 423   1              for( i = 0; i < (6 * 3 + 1); i++ ){
 424   2                      Parameter_Buf[i] = ISP_Byte_Read( Parameter_Address++ );
C51 COMPILER V8.08   C_MAIN                                                                07/29/2010 17:32:25 PAGE 8   

 425   2              }
 426   1      
 427   1              // Èç¹û²ÎÊýÕýÈ· ÔòÅäÖÃCS5460
 428   1              if( Parameter_Buf[ ( 6*3 ) ] == 0x00 ){ 
 429   2                      CS5460_WriteReg( addIDCOffset, Parameter_Buf[ 0 ], Parameter_Buf[ 1 ], Parameter_Buf[ 2 ] );
 430   2                      CS5460_WriteReg( addIGain,     Parameter_Buf[ 3 ], Parameter_Buf[ 4 ], Parameter_Buf[ 5 ] );
 431   2                      CS5460_WriteReg( addVDCOffset, Parameter_Buf[ 6 ], Parameter_Buf[ 7 ], Parameter_Buf[ 8 ] );
 432   2                      CS5460_WriteReg( addVGain,     Parameter_Buf[ 9 ], Parameter_Buf[ 10 ], Parameter_Buf[ 11 ] );
 433   2                      CS5460_WriteReg( addIACOffset, Parameter_Buf[ 12 ], Parameter_Buf[ 13 ], Parameter_Buf[ 14 ] );
 434   2                      CS5460_WriteReg( addVACOffset, Parameter_Buf[ 15 ], Parameter_Buf[ 16 ], Parameter_Buf[ 17 ] );
 435   2              }
 436   1      
 437   1      }
 438          
 439          /*=======================================================================
 440          º¯ÊýÃû³Æ£ºSave_Parameter
 441          º¯Êý¹¦ÄÜ£º±£´æ²ÎÊýÖµ
 442          ÊäÈë²ÎÊý£ºÎÞ
 443          Êä³ö²ÎÊý£ºÎÞ
 444          ·µ »Ø Öµ£ºÎÞ
 445          ÆäËüËµÃ÷£º
 446          =======================================================================*/
 447          void Save_Parameter( void ){
 448   1      
 449   1              unsigned char i;
 450   1              unsigned  int Parameter_Address;
 451   1      
 452   1              Parameter_Address = 0;
 453   1              Sector_Erase( Parameter_Address );
 454   1      
 455   1              CS5460_Status = CS5460_ReadReg( addIDCOffset );
 456   1              Parameter_Buf[ 0 ]  = CS5460_Status;     
 457   1              Parameter_Buf[ 1 ]  = ( CS5460_Status >> 8 );
 458   1              Parameter_Buf[ 2 ]  = ( CS5460_Status   >> 16 );
 459   1      
 460   1              CS5460_Status = CS5460_ReadReg( addIGain );
 461   1              Parameter_Buf[ 3 ]  = CS5460_Status;     
 462   1              Parameter_Buf[ 4 ]  = ( CS5460_Status >> 8 );
 463   1              Parameter_Buf[ 5 ]  = ( CS5460_Status   >> 16 );
 464   1      
 465   1              CS5460_Status = CS5460_ReadReg( addVDCOffset );
 466   1              Parameter_Buf[ 6 ]  = CS5460_Status;     
 467   1              Parameter_Buf[ 7 ]  = ( CS5460_Status >> 8 );
 468   1              Parameter_Buf[ 8 ]  = ( CS5460_Status   >> 16 );
 469   1      
 470   1      
 471   1              CS5460_Status = CS5460_ReadReg( addVGain );
 472   1              Parameter_Buf[ 9 ]  = CS5460_Status;     
 473   1              Parameter_Buf[ 10 ]  = ( CS5460_Status >> 8 );
 474   1              Parameter_Buf[ 11 ]  = ( CS5460_Status  >> 16 );
 475   1      
 476   1              CS5460_Status = CS5460_ReadReg( addIACOffset );
 477   1              Parameter_Buf[ 12 ]  = CS5460_Status;    
 478   1              Parameter_Buf[ 13 ]  = ( CS5460_Status >> 8 );
 479   1              Parameter_Buf[ 14 ]  = ( CS5460_Status  >> 16 );
 480   1      
 481   1              CS5460_Status = CS5460_ReadReg( addVACOffset );
 482   1              Parameter_Buf[ 15 ]  = CS5460_Status;    
 483   1              Parameter_Buf[ 16 ]  = ( CS5460_Status >> 8 );
 484   1              Parameter_Buf[ 17 ]  = ( CS5460_Status  >> 16 );
 485   1      
 486   1              Parameter_Buf[ 18 ]  = 0x00;
C51 COMPILER V8.08   C_MAIN                                                                07/29/2010 17:32:25 PAGE 9   

 487   1      
 488   1              for( i = 0; i < (6 * 3 + 1); i++ ){
 489   2                      ISP_Byte_Write( Parameter_Address++, Parameter_Buf[i] );
 490   2              }
 491   1      
 492   1      }
 493          
 494          
 495          /*=======================================================================
 496          º¯ÊýÃû³Æ£ºSystem_PowerOn
 497          º¯Êý¹¦ÄÜ£ºÏµÍ³¸ÕÉÏµçÐèÒª´¦ÀíµÄÊÂÇé
 498          ÊäÈë²ÎÊý£ºÎÞ
 499          Êä³ö²ÎÊý£ºÎÞ
 500          ·µ »Ø Öµ£ºÎÞ
 501          ÆäËüËµÃ÷£º1¡¢ÑÓÊ±1S
 502                            2¡¢Ö¸Ê¾µÆÒÔ0.3SÉÁË¸
 503                            3¡¢Ê¹ÄÜµçÑ¹Í¨µÀ£¬µçÁ÷Í¨µÀ£¬ÇÐ»»µ½0Í¨µÀ
 504                            4¡¢¸´Î»CS5460
 505                            5¡¢Ìø×ªµ½ÏµÍ³¿ÕÏÐ×´Ì¬
 506          =======================================================================*/
 507          void System_PowerOn( void ){
 508   1      
 509   1              // Ö¸Ê¾µÆÒÔ0.3SÉÁË¸
 510   1              if( (State_Timer % 30) == 0 ) { SystemLED_Flag = ~SystemLED_Flag; }
 511   1      
 512   1              // Ê¹ÄÜµçÑ¹Í¨µÀ£¬µçÁ÷Í¨µÀ£¬ÇÐ»»µ½0Í¨µÀ ¸´Î»CS5460
 513   1              if( State_Timer == 100 ){
 514   2                      CS5460_RSTLow;
 515   2                      CS5460_Channel = 0;
 516   2                      CD4051_A = 1;
 517   2                      CD4051_B = 0;
 518   2                      CD4051_C = 0;
 519   2                      CD4051_EN0 = 0;
 520   2                      CD4051_EN1 = 0;
 521   2      
 522   2              }
 523   1              if( State_Timer == 103 ){ CS5460_RSTHigh; } // ¸´Î»Íê³É
 524   1      
 525   1              // Í¬²½CS5460µÄ´®ÐÐ¿Ú
 526   1              if( State_Timer == 104 ){
 527   2                      CS5460_CSLow;
 528   2                      CS5460_Send( cmdSYNC1 );  // 
 529   2                      CS5460_Send( cmdSYNC1 );  // 
 530   2                      CS5460_Send( cmdSYNC1 );  // 
 531   2                      CS5460_Send( cmdSYNC0 );  // 
 532   2                      CS5460_CSHigh;
 533   2              //      Get_Parameter();
 534   2                      CS5460_WriteReg( addConfig, 0x00, 0x10, 0x63 ); // ÅäÖÃConfig
 535   2              }
 536   1      
 537   1              if( State_Timer == 106 ){                       
 538   2                      CS5460_SendCmd( cmdStartCVTCtinu );  // ·¢ËÍÁ¬ÐøÆô¶¯×ª»»ÃüÁî  
 539   2                      // »ñÈ¡Éè±¸µØÖ·
 540   2                      Device_Address = P1;
 541   2                      Device_Address >>= 4;
 542   2                      Device_Address =  con_HexCode[Device_Address];
 543   2                      System_State = conSysIDLEState; State_Timer = 0;  // 1Ãëºó Ìø×ªµ½ÏµÍ³¿ÕÏÐ×´Ì¬
 544   2                      Max485_Rece;
 545   2              }
 546   1      
 547   1      }
 548          
C51 COMPILER V8.08   C_MAIN                                                                07/29/2010 17:32:25 PAGE 10  

 549          /*=======================================================================
 550          º¯ÊýÃû³Æ£ºSystem_IDLE
 551          º¯Êý¹¦ÄÜ£ºÏµÍ³¿ÕÏÐÐèÒª´¦ÀíµÄÊÂÇé
 552          ÊäÈë²ÎÊý£ºÎÞ
 553          Êä³ö²ÎÊý£ºÎÞ
 554          ·µ »Ø Öµ£ºÎÞ
 555          ÆäËüËµÃ÷£º1¡¢Ö¸Ê¾µÆÒÔ1SÉÁË¸
 556                            2¡¢Ã¿Ò»ÃëÇÐ»»Ò»´ÎÍ¨µÀ£¬Æô¶¯CS5460×ª»»Ò»´Î£¬¶ÁÈ¡Ò»´Î×ª»»½á¹û£¬²¢°Ñ½á¹û¸üÐÂµ½ÏàÓ¦µÄ»º³åÇø
 557                            3¡¢Èç¹ûÊÕµ½´®ÐÐ¿ÚÊý¾Ý°ü£¬Ôò½â°ü²¢´¦Àí
 558                            4¡¢Ã¿Ò»ÃëÊý¾Ý´ò°üÒ»´Î£¬²¢Ö÷¶¯ÉÏ´«Ò»´Î£¨µ÷ÊÔÓÃ£©
 559          =======================================================================*/
 560          void System_IDLE( void ){       
 561   1      
 562   1                bit Plus_Flag;
 563   1              float Temp_f;
 564   1              unsigned long Temp_l;
 565   1      
 566   1              // Ã¿10ms¶ÁÒ»´ÎCS5460µÄ×´Ì¬×Ö£¬¸ù¾Ý×´Ì¬×ÖÀ´ÅÐ¶ÏÏÂÒ»²½µÄ²Ù×÷
 567   1              CS5460_Status = CS5460_ReadReg( addStatus );
 568   1              CS5460_Flag2  = CS5460_Status;   
 569   1              CS5460_Flag1  = ( CS5460_Status >> 8 );
 570   1              CS5460_Flag0  = ( CS5460_Status >> 16 );
 571   1              if( DRDY_Flag == 1 ){ // ¶ÁÈ¡µ±Ç°×ª»»½á¹û                       
 572   2                      Read_State++;
 573   2                      if( Read_State != 3 ){
 574   3                              // Çå³ý±êÖ¾
 575   3                              CS5460_WriteReg( addStatus, CS5460_Flag0, CS5460_Flag1, CS5460_Flag2 );
 576   3                              Temp_l = CS5460_ReadReg( addVRMS );
 577   3                              Temp_l = CS5460_ReadReg( addIRMS );
 578   3                              Temp_l = CS5460_ReadReg( addP );
 579   3                      }
 580   2                      if( Read_State >= 3 ){ Read_State = 0;
 581   3                              // »ñÈ¡µçÑ¹ÕæÓÐÐ§Öµ                     
 582   3                              Temp_f = CS5460_ReadReg( addVRMS ); // ×ª»»Îª¸¡µãÊý
 583   3                              Temp_f *= conVoltage_Cof;               // ×ª»»ÎªÐ¡Êý ³ËÉÏÏµÊý
 584   3                              Temp_l  = Temp_f;                       // ×ª»»Îª³¤ÕûÐÎÊý
 585   3                              // ²ð·Öµ½ÏàÓ¦Í¨µÀµÄÏàÓ¦Ïî»º³åÇø         
 586   3                              LongToASCII( &Measure_Buf[CS5460_Channel][0][0], Temp_l, 'V' );
 587   3                              // »ñÈ¡µçÁ÷ÕæÓÐÐ§Öµ
 588   3                              Temp_f = CS5460_ReadReg( addIRMS );     // ×ª»»Îª¸¡µãÊý
 589   3                              Temp_f *= conCurrent_Cof;               // ×ª»»ÎªÐ¡Êý ³ËÉÏÏµÊý
 590   3                              Temp_l  = Temp_f;                       // ×ª»»Îª³¤ÕûÐÎÊý
 591   3                              // ²ð·Öµ½ÏàÓ¦Í¨µÀµÄÏàÓ¦Ïî»º³åÇø
 592   3                              LongToASCII( &Measure_Buf[CS5460_Channel][1][0], Temp_l, 'I' );
 593   3                              // »ñÈ¡¹¦ÂÊÖµ
 594   3                              Temp_l = CS5460_ReadReg( addP );
 595   3                              Plus_Flag = 0;
 596   3                              if( Temp_l & 0x00800000 ){ 
 597   4                                      Plus_Flag = 1; 
 598   4                                      Temp_l &= 0x007FFFFF; 
 599   4                              }
 600   3                              Temp_f = Temp_l;        // ×ª»»Îª¸¡µãÊý
 601   3                              Temp_f *= conPower_Cof;         // ×ª»»ÎªÐ¡Êý ³ËÉÏÏµÊý
 602   3                              Temp_l  = Temp_f;                       // ×ª»»Îª³¤ÕûÐÎÊý
 603   3                              // ²ð·Öµ½ÏàÓ¦Í¨µÀµÄÏàÓ¦Ïî»º³åÇø
 604   3                              LongToASCII( &Measure_Buf[CS5460_Channel][2][0], Temp_l, 'P' );
 605   3                              if( Plus_Flag ) { Measure_Buf[CS5460_Channel][2][0] = '-'; }
 606   3                              // Çå³ý±êÖ¾
 607   3                              CS5460_WriteReg( addStatus, CS5460_Flag0, CS5460_Flag1, CS5460_Flag2 );
 608   3                              // ÇÐ»»Í¨µÀ
 609   3                              CS5460_Channel++;
 610   3                              if( CS5460_Channel >= 6 ){ CS5460_Channel = 0; }
C51 COMPILER V8.08   C_MAIN                                                                07/29/2010 17:32:25 PAGE 11  

 611   3                              //CS5460_Channel = 1;
 612   3                              Output_Channel = con_ChannelChange[ CS5460_Channel ];
 613   3                              CD4051_EN0 = 1; 
 614   3                              CD4051_EN1 = 1;
 615   3                              if( ( Output_Channel & 0x01 ) == 0x01 ){ CD4051_A = 1; }
 616   3                              else                                   { CD4051_A = 0; }
 617   3                              if( ( Output_Channel & 0x02 ) == 0x02 ){ CD4051_B = 1; }
 618   3                              else                                   { CD4051_B = 0; }
 619   3                              if( ( Output_Channel & 0x04 ) == 0x04 ){ CD4051_C = 1; }
 620   3                              else                                   { CD4051_C = 0; }
 621   3                              CD4051_EN0 = 0; 
 622   3                              CD4051_EN1 = 0;
 623   3                      }
 624   2                      
 625   2              }
 626   1      
 627   1              // 1sµ½
 628   1              if( ( State_Timer % 100 ) == 0 ){ State_Timer = 0;
 629   2                      SystemLED_Flag = ~SystemLED_Flag;
 630   2              }
 631   1      
 632   1      }  
 633          
 634          /*=======================================================================
 635          º¯ÊýÃû³Æ£ºWait_DRDY
 636          º¯Êý¹¦ÄÜ: 
 637          ÊäÈë²ÎÊý£ºÎÞ
 638          Êä³ö²ÎÊý£ºÎÞ
 639          ·µ »Ø Öµ£ºÎÞ
 640          ÆäËüËµÃ÷£º1¡¢Ð£×¼ÆÚ¼äÖ¸Ê¾µÆ³£ÁÁ
 641                            2¡¢Ð£×¼Íê³ÉºóÖ¸Ê¾µÆÉÁ3´Î,²¢ÉÏ´«Ð£×¼Íê³ÉÏûÏ¢
 642                            3¡¢Ð£×¼ºóµÄÏµÊý´æÈëE2PROMÖÐ
 643          =======================================================================*/
 644          void Wait_DRDY( void ){
 645   1              CS5460_Status = CS5460_ReadReg( addStatus );
 646   1              CS5460_Flag2  = CS5460_Status;   
 647   1              CS5460_Flag1  = ( CS5460_Status >> 8 );
 648   1              CS5460_Flag0  = ( CS5460_Status >> 16 );
 649   1      }
 650                                                                    //       IDCÆ«ÖÃÐ£×¼  IACÆ«ÖÃÐ£×¼   IDCÔöÒæÐ£×¼    IACÔöÒæÐ£×¼
 651          unsigned char code con_CabTab[] = { (0xC1 | 0x01), (0xC1 | 0x05), (0xC1 | 0x02), (0xC1 | 0x06),
 652                                                                    //       VDCÆ«ÖÃÐ£×¼  VACÆ«ÖÃÐ£×¼   VDCÔöÒæÐ£×¼    VACÔöÒæÐ£×¼
 653                                                                                  (0xD0 | 0x01), (0xD0 | 0x05), (0xD0 | 0x02), (0xD0 | 0x06)
 654                                                                            };
 655          /*=======================================================================
 656          º¯ÊýÃû³Æ£ºSystem_Cab
 657          º¯Êý¹¦ÄÜ£ºÏµÍ³Ð£×¼º¯Êý
 658          ÊäÈë²ÎÊý£ºÎÞ
 659          Êä³ö²ÎÊý£ºÎÞ
 660          ·µ »Ø Öµ£ºÎÞ
 661          ÆäËüËµÃ÷£º1¡¢Ð£×¼ÆÚ¼äÖ¸Ê¾µÆ³£ÁÁ
 662                            2¡¢Ð£×¼Íê³ÉºóÖ¸Ê¾µÆÉÁ3´Î,²¢ÉÏ´«Ð£×¼Íê³ÉÏûÏ¢
 663                            3¡¢Ð£×¼ºóµÄÏµÊý´æÈëE2PROMÖÐ
 664          =======================================================================*/
 665          void System_Cab( void ){
 666   1      
 667   1              SystemLED_Flag = con_LEDOn;
 668   1      
 669   1              // Çå±ê¼Ç
 670   1              CS5460_WriteReg( addStatus, 0xFF, 0xFF, 0xFF );
 671   1              // 1¡¢·¢ËÍPower_UpÃüÁî
 672   1              CS5460_SendCmd( cmdPowerUpHalt );
C51 COMPILER V8.08   C_MAIN                                                                07/29/2010 17:32:25 PAGE 12  

 673   1              // Çå±ê¼Ç
 674   1              CS5460_WriteReg( addStatus, 0xFF, 0xFF, 0xFF ); 
 675   1              // 2¡¢¸ù¾ÝÒªÐ£×¼µÄÏî£¬·¢ËÍÏàÓ¦µÄÐ£×¼ÃüÁî
 676   1              // 3¡¢µÈ´ýÏµÍ³Ð£×¼Íê³É
 677   1              CS5460_SendCmd( con_CabTab[ CS5460_CabNum ]  );
 678   1              DRDY_Flag = 0;
 679   1              while( DRDY_Flag == 0 ){
 680   2                 Wait_DRDY();
 681   2              }
 682   1              // Ð£×¼Íê³É
 683   1              // Çå³ý±êÖ¾
 684   1              CS5460_WriteReg( addStatus, CS5460_Flag0, CS5460_Flag1, CS5460_Flag2 );
 685   1              // 4¡¢»ñÈ¡ÏàÓ¦µÄ²ÎÊý
 686   1              // 5¡¢°ÑÐ£×¼²ÎÊýÐ´ÈëE2PromÖÐ
 687   1              Save_Parameter( );
 688   1              CS5460_SendCmd( cmdStartCVTCtinu );  // ·¢ËÍÁ¬ÐøÆô¶¯×ª»»ÃüÁî
 689   1              // 6¡¢·¢ËÍÐ£×¼OKÃüÁî¸ø´®ÐÐ¿Ú
 690   1              UART0_TranState = 'C';
 691   1              // 7¡¢Ï¨ÃðLED
 692   1              SystemLED_Flag = con_LEDOff;
 693   1              // 8¡¢ÇÐ»»µ½ÏµÍ³¿ÕÏÐ×´Ì¬
 694   1              System_State = conSysIDLEState; State_Timer = 0;
 695   1      
 696   1      }
 697          
 698          /*=======================================================================
 699          º¯ÊýÃû³Æ£ºOutput_Port
 700          º¯Êý¹¦ÄÜ£º¶Ë¿ÚË¢ÐÂº¯Êý
 701          ÊäÈë²ÎÊý£ºÎÞ
 702          Êä³ö²ÎÊý£ºÎÞ
 703          ·µ »Ø Öµ£ºÎÞ
 704          ÆäËüËµÃ÷£ºÎÞ
 705          =======================================================================*/
 706          void Output_Port( void ){
 707   1      
 708   1              System_LED = SystemLED_Flag;
 709   1      
 710   1      }
 711          
 712          /*=======================================================================
 713          º¯ÊýÃû³Æ£ºmain
 714          º¯Êý¹¦ÄÜ£º
 715          ÊäÈë²ÎÊý£ºÎÞ
 716          Êä³ö²ÎÊý£ºÎÞ
 717          ·µ »Ø Öµ£ºÎÞ
 718          ÆäËüËµÃ÷£ºÎÞ
 719          =======================================================================*/
 720          void main( void ){
 721   1      
 722   1              Max485_Rece;             // 485½ÓÊÕÊ¹ÄÜ
 723   1              System_LED = con_LEDOn;  // µãÁÁÏµÍ³Ö¸Ê¾µÆ
 724   1              Init_System( );
 725   1      
 726   1              while(1){
 727   2      
 728   2                      // Ã¿10msÒª×öµÄÊÂÇé
 729   2                      if( Flag_10ms ){ Flag_10ms = 0;
 730   3                                              // ×ÜÒª×öµÄÊÂÇé
 731   3                              if( UART0_ReceOKFlag ){ // ´®ÐÐ¿Ú½ÓÊÕºÃ
 732   4                                      UART0_UnPacket( );      // µ÷ÓÃ´®ÐÐ¿Ú½â°üÃüÁî
 733   4                                      UART0_ReceOKFlag = 0; // Çå½ÓÊÕºÃ±ê¼Ç
 734   4                              }
C51 COMPILER V8.08   C_MAIN                                                                07/29/2010 17:32:25 PAGE 13  

 735   3                              if( UART0_TranState ){ UART0_Packet(); }
 736   3                              // ÏµÍ³×´Ì¬»ú´¦Àí
 737   3                              if( State_Timer < 65530 ) { State_Timer++; }                    
 738   3                              switch( System_State ){
 739   4                                      case conSysPowerOnState: System_PowerOn(); break;
 740   4                                      case conSysIDLEState:    System_IDLE();    break;
 741   4                                      case conSysCabState:     System_Cab();     break;
 742   4                                      default: System_State = conSysPowerOnState; State_Timer = 0;  break;
 743   4                              } // ÏµÍ³×´Ì¬»ú´¦Àí½áÊø
 744   3      
 745   3                              // 10msË¢ÐÂÒ»´ÎÊä³ö¶Ë¿Ú
 746   3                              Output_Port( );
 747   3      
 748   3                      } // 10msÊÂ¼þ´¦Àí½áÊø
 749   2              }
 750   1      
 751   1      }
 752          
 753          
 754          
 755          /*=======================================================================
 756          º¯ÊýÃû³Æ£ºISR_INT0  Íâ²¿ÖÐ¶Ï0µÄÖÐ¶Ï·þÎñ
 757          º¯Êý¹¦ÄÜ£ººìÍâÏßÊäÈë¼ì²â          
 758          ÊäÈë²ÎÊý£ºÎÞ
 759          Êä³ö²ÎÊý£ºÎÞ
 760          ·µ »Ø Öµ£ºÎÞ
 761          ÆäËüËµÃ÷£ºÎÞ
 762          =======================================================================*/
 763          void ISR_INT0( void ) interrupt 0  using 1{
 764   1              
 765   1                       
 766   1      }
 767          
 768          /*=======================================================================
 769          º¯ÊýÃû³Æ£ºISR_Timer0  ¶¨Ê±Æ÷T0ÖÐ¶Ï·þÎñ
 770          º¯Êý¹¦ÄÜ£ºÊµÏÖ10ms¶¨Ê±ÖÐ¶Ï          
 771          ÊäÈë²ÎÊý£ºÎÞ
 772          Êä³ö²ÎÊý£ºÎÞ
 773          ·µ »Ø Öµ£ºÎÞ
 774          ÆäËüËµÃ÷£ºÎÞ
 775          =======================================================================*/
 776          void ISR_Timer0( void ) interrupt 1  //using 1
 777          {
 778   1                                
 779   1              TH0   = 0xD5;
 780   1              TL0   = 0x9D;
 781   1      
 782   1              Flag_10ms = 1;
 783   1      
 784   1      } 
 785          
 786          /*=======================================================================
 787          º¯ÊýÃû³Æ£ºISR_INT1  Íâ²¿ÖÐ¶Ï1µÄÖÐ¶Ï·þÎñ
 788          º¯Êý¹¦ÄÜ£º¼üÅÌÊäÈë¼ì²â          
 789          ÊäÈë²ÎÊý£ºÎÞ
 790          Êä³ö²ÎÊý£ºÎÞ
 791          ·µ »Ø Öµ£ºÎÞ
 792          ÆäËüËµÃ÷£ºÎÞ
 793          =======================================================================*/
 794          void ISR_INT1( void ) interrupt 2  //using 1
 795          {
 796   1               
C51 COMPILER V8.08   C_MAIN                                                                07/29/2010 17:32:25 PAGE 14  

 797   1      }
 798          
 799          /*=======================================================================
 800          º¯ÊýÃû³Æ£ºISR_Timer1  ¶¨Ê±Æ÷T1ÖÐ¶Ï·þÎñ
 801          º¯Êý¹¦ÄÜ£ºÊµÏÖ1ms¶¨Ê±ÖÐ¶Ï          
 802          ÊäÈë²ÎÊý£ºÎÞ
 803          Êä³ö²ÎÊý£ºÎÞ
 804          ·µ »Ø Öµ£ºÎÞ
 805          ÆäËüËµÃ÷£ºÎÞ
 806          =======================================================================*/
 807          void ISR_Timer1( void ) interrupt 3 // using 1
 808          {
 809   1      
 810   1      }
 811          
 812          /*=======================================================================
 813          º¯ÊýÃû³Æ£ºISR_Serial0 ´®ÐÐ¿Ú0ÖÐ¶Ï·þÎñ
 814          º¯Êý¹¦ÄÜ£ºÏµÍ³µ÷ÊÔ      
 815          ÊäÈë²ÎÊý£ºÎÞ
 816          Êä³ö²ÎÊý£ºÎÞ
 817          ·µ »Ø Öµ£ºÎÞ
 818          ÆäËüËµÃ÷£ºÎÞ
 819          =======================================================================*/
 820          void ISR_UART0( void ) interrupt 4 // using 1
 821          {
 822   1          unsigned char Temp_Data;
 823   1      
 824   1              // ½ÓÊÕÖÐ¶Ï
 825   1          if( RI ){  RI = 0;
 826   2                      if( UART0_ReceOKFlag == 0 ){
 827   3                          Temp_Data = SBUF;
 828   3                          if( Temp_Data == '[' ){     UART0_ReceCounter = 0; }
 829   3                          UART0_ReceBuf[ UART0_ReceCounter++ ] = Temp_Data;
 830   3                          if( UART0_ReceCounter == con_UART0ReceMaxNum ){
 831   4                              UART0_ReceCounter = 0;
 832   4                              if( Temp_Data == ']' ){ // °üÍêÕûÐÔÐ£Ñé
 833   5                                              // ±¾»úµØÖ·Ð£Ñé
 834   5                                              if( UART0_ReceBuf[1] == Device_Address ){
 835   6                                                  UART0_ReceOKFlag = 1; // µ÷ÊÔÓÃ,ÔÝ²»×öCRCÐ£Ñé
 836   6                                              }                              
 837   5                                  }
 838   4                          }
 839   3                      }
 840   2              }
 841   1      
 842   1              // ·¢ËÍÖÐ¶Ï
 843   1              if( TI ){ TI = 0; 
 844   2                      if( UART0_TranCounter < UART0_TranMaxNum ){
 845   3                              SBUF = UART0_TranBuf[ UART0_TranCounter++ ];                    
 846   3                      }
 847   2                      else{
 848   3                              Max485_Rece;             // 485½ÓÊÕÊ¹ÄÜ
 849   3                      }
 850   2              }
 851   1      
 852   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2243    ----
   CONSTANT SIZE    =     43    ----
   XDATA SIZE       =    211    ----
C51 COMPILER V8.08   C_MAIN                                                                07/29/2010 17:32:25 PAGE 15  

   PDATA SIZE       =   ----    ----
   DATA SIZE        =     12      29
   IDATA SIZE       =     42    ----
   BIT SIZE         =      3       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
